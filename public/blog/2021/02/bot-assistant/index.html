<!DOCTYPE html>
<html class="h-full">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1315&amp;path=livereload" data-no-instant defer></script>
    <title>Build Your Own Custom Robot Assistant</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet"><script defer src="/js/alpine_3_11_1.js"></script>

  <meta property="og:type" content="article" />
  <meta property="og:title" content="Build Your Own Custom Robot Assistant" />
  <meta property="og:description" content="Use data streaming to build a custom robot assistant that can connect to any backend service in the organization." />
  <meta property="og:image" content="http://localhost:1315/blog/images/bot-assistant/social/bot.jpg">
  <meta name="twitter:site" content="@InfinyOn">
  <meta name="twitter:image:src" content="http://localhost:1315/blog/images/bot-assistant/social/bot.jpg" />
  <meta name="twitter:card" content="summary_large_image" />

  </head>
  <body>
    
<div class="relative isolate flex items-center gap-x-6 overflow-hidden bg--100 py-2.5 px-6 sm:px-3.5 sm:before:flex-1 bg-indigo-300">
  <div class="flex flex-auto items-center gap-y-2 gap-x-4">
    <p class="text-sm leading-6 text-gray-900">
      <strong class="font-semibold">Stateful Services (private release)</strong>
      <svg viewBox="0 0 2 2" class="mx-2 inline h-0.5 w-0.5 fill-current" aria-hidden="true"><circle cx="1" cy="1" r="1" /></svg>
      Build composable event-driven data pipelines in minutes.
    </p>
    <a href="/request/ss-early-access" class="flex-none rounded-full bg-gray-900 py-1 px-3.5 text-sm font-semibold text-white shadow-sm hover:bg-gray-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-900">
      Request access <span aria-hidden="true">&rarr;</span>
    </a>
  </div>
</div><div id="content">
      <header id="header" class="sticky top-0 z-20">
        <div 
  x-data="{ isOpen: false, menuOpen: '', showBorder: false }"
  @scroll.window="showBorder = (document.querySelector('#header').getBoundingClientRect().top <= 0 && window.pageYOffset > 2 ) ? true : false"
  :class="{ 'border-b border-gray-700' : showBorder}"
>
  <div class="bg-magenta-900 pt-4 pb-4">
    <nav class="relative mx-auto flex max-w-7xl items-center justify-between px-6" aria-label="Global">
      <div class="flex flex-1 items-center">
        <div class="flex w-full items-center justify-between md:w-auto">
          <a href="/">
            <span class="sr-only">InfinyOn</span>
            <img class="h-6 w-auto" src="/assets/infinyon-logo-text-white.svg" alt="InfinyOn">
          </a>

          <div class="-mr-2 flex items-center md:hidden">
            <button 
              @click="isOpen = !isOpen" 
              type="button" 
              class="focus-ring-inset inline-flex items-center justify-center rounded-md bg-magenta-900 p-2 text-gray-400 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-white" aria-expanded="false"
              >
              <span class="sr-only">Open main menu</span>
              
              <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.4" stroke="white" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
              </svg>
            </button>                  
          </div>
        </div>

        <div class="hidden space-x-8 md:ml-10 md:flex">
              
            <div x-data="{ showDropdown: false }">
  <button 
    @mouseover="showDropdown = true"
    @mouseleave="showDropdown = false"
    @click="showDropdown = !showDropdown"
    type="button" 
    :class="{ 'text-gray-900' : showDropdown }"
    class="group inline-flex items-center rounded-md text-base text-white hover:text-gray-300" aria-expanded="false">
    <span>Use Cases</span>
    <svg 
      :class="{ 'rotate-90 text-gray-300' : showDropdown }"
      class="ml-2 h-4 w-4 text-white group-hover:text-gray-300"
      xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
  </button>

  <div
    x-cloak
    x-show="showDropdown"
    @mouseover="showDropdown = true"
    @mouseleave="showDropdown = false"
    class="absolute z-10 pt-3 transform shadow-lg"
  >

    <div class="overflow-hidden rounded-md shadow-md ring-1 ring-black ring-opacity-5">
        <div class="relative px-8 py-7 bg-slate-50" aria-labelledby="solutions-heading">
          <ul role="list" class="space-y-5">
              <li class="flow-root">
                <a href="/clickstream" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                  <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672L13.684 16.6m0 0l-2.51 2.225.569-9.47 5.227 7.917-3.286-.672zm-7.518-.267A8.25 8.25 0 1120.25 10.5M8.288 14.212A5.25 5.25 0 1117.25 10.5" />
</svg><span class="ml-4">Clickstream Analytics</span>
                </a>
              </li>
              <li class="flow-root">
                <a href="/iot" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                  <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.789m13.788 0c3.808 3.808 3.808 9.981 0 13.79M12 12h.008v.007H12V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
</svg><span class="ml-4">IoT Mirroring</span>
                </a>
              </li>
              <li class="flow-root">
                <a href="/stateful-streaming" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                  <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
</svg>
<span class="ml-4">Stateful Streaming</span>
                </a>
              </li>
          </ul>
        </div>
    </div>
  </div>
  
</div>    
            
<a href="/docs" class="text-base text-white hover:text-gray-300 " class="">Docs</a>    
            
<a href="/blog" class="text-base text-white hover:text-gray-300  underline underline-offset-8 decoration-1" class="">Blog</a>    
            <div x-data="{ showDropdown: false }">
  <button 
    @mouseover="showDropdown = true"
    @mouseleave="showDropdown = false"
    @click="showDropdown = !showDropdown"
    type="button" 
    :class="{ 'text-gray-900' : showDropdown }"
    class="group inline-flex items-center rounded-md text-base text-white hover:text-gray-300" aria-expanded="false">
    <span>Resources</span>
    <svg 
      :class="{ 'rotate-90 text-gray-300' : showDropdown }"
      class="ml-2 h-4 w-4 text-white group-hover:text-gray-300"
      xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
    </svg>
  </button>

  <div
    x-cloak
    x-show="showDropdown"
    @mouseover="showDropdown = true"
    @mouseleave="showDropdown = false"
    class="absolute z-10 pt-3 transform shadow-lg"
  >

    <div class="overflow-hidden rounded-md shadow-md ring-1 ring-black ring-opacity-5">
        <div class="relative px-16 py-8 grid grid-cols-2 gap-24 bg-slate-50" aria-labelledby="solutions-heading">

          <div>
            <h3 class="text-md text-gray-700">Company</h3>
            <ul role="list" class="mt-4 space-y-6">
                <li class="flow-root">
                  <a href="/about" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path strokeLinecap="round" strokeLinejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
</svg><span class="ml-4">About</span>
                  </a>
                </li>
                <li class="flow-root">
                  <a href="/careers" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 00.75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 00-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0112 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 01-.673-.38m0 0A2.18 2.18 0 013 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 013.413-.387m7.5 0V5.25A2.25 2.25 0 0013.5 3h-3a2.25 2.25 0 00-2.25 2.25v.894m7.5 0a48.667 48.667 0 00-7.5 0M12 12.75h.008v.008H12v-.008z" />
</svg><span class="ml-4">Careers</span>
                  </a>
                </li>
                <li class="flow-root">
                  <a href="/press-releases" target="_self" class="-m-3 flex items-center rounded-md p-3 text-gray-700 hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" />
</svg><span class="ml-4">Press</span>
                  </a>
                </li>

            </ul>
          </div>

          <div>
            <h3 class="text-md text-gray-700">Resources</h3>
            <ul role="list" class="mt-4 space-y-6">
                <li class="flow-root">
                  <a href="/resources" class="-m-3 flex items-center rounded-md p-3 text-gray-700  hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6A2.25 2.25 0 016 3.75h1.5m9 0h-9" />
</svg><span class="ml-4">Articles</span>
                  </a>
                </li>
                <li class="flow-root">
                  <a href="/webinars" class="-m-3 flex items-center rounded-md p-3 text-gray-700  hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
</svg><span class="ml-4">Webinars</span>
                  </a>
                </li>
                <li class="flow-root">
                  <a href="https://www.youtube.com/@infinyon/videos" class="-m-3 flex items-center rounded-md p-3 text-gray-700  hover:bg-slate-100">
                    <svg class="w-6 h-6 text-magenta-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
  <path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" />
</svg><span class="ml-4">Videos</span>
                  </a>
                </li>

            </ul>
          </div>
        </div>
  
    </div>
  </div>
  
</div>    
                
            </div>

      </div>
      
      <div class="hidden md:flex md:items-center md:space-x-6">
            
          
        <a href="https://infinyon.cloud?utm_campaign=global%20cloud%20link&amp;utm_source=website&amp;utm_medium=global%20button&amp;utm_term=infinyon%20cloud&amp;utm_content=cloud-registration" class="inline-flex items-center rounded-md px-4 py-1.5 text-sm font-semibold text-white bg-indigo-500 hover:bg-indigo-600">Cloud Login</a>
      </div>
    </nav>
  </div>

  <div class="absolute inset-x-0 top-0 px-2 origin-top transform transition md:hidden">
  <div x-show="isOpen" x-cloak x-transition:enter="duration-150 ease-out" x-transition:enter-start="opacity-0 scale-95"
    x-transition:enter-end="opacity-100 scale-100" x-transition:leave="duration-100 ease-in"
    x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
    class="overflow-hidden rounded-lg bg-slate-50 shadow-lg ring-1 ring-black ring-opacity-5">

    <div class="flex items-center justify-between px-5 pt-4 pb-2 bg-magenta-900">
      <div>
        <a href="/">
          <span class="sr-only">InfinyOn</span>
          <img class="h-6 w-auto" src="/assets/infinyon-logo-text-white.svg" alt="InfinyOn">
        </a>
      </div>
      <div class="-mr-2">
        <button type="button" @click="isOpen = !isOpen"
          class="inline-flex items-center justify-center rounded-md bg-white p-2 text-gray-400 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-cyan-600">
          <span class="sr-only">Close menu</span>
          
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="pt-5 pb-6 max-h-screen -mb-16 overflow-y-auto">
      <div class="mb-16 space-y-1 px-2">
            
              <p class="block px-3 pt-3 text-md font-medium text-gray-700">Use Cases</p>
                
                <div class="ml-5">
                  
                    <a href="/clickstream"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Clickstream Analytics</a>
                  
                    <a href="/iot"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">IoT Mirroring</a>
                  
                    <a href="/stateful-streaming"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Stateful Streaming</a>
                  </div>
              <p class="block px-3 pt-3 text-md font-medium text-gray-700">Documentation</p> 
              <a href="/docs"
                class="block rounded-md ml-5 px-3 py-2 text-blue-700 hover:bg-gray-50">Docs</a>
              <p class="block px-3 pt-3 text-md font-medium text-gray-700">Blog Articles</p> 
              <a href="/blog"
                class="block rounded-md ml-5 px-3 py-2 text-blue-700 hover:bg-gray-50">Blog</a>
            
              <p class="block px-3 pt-3 text-md font-medium text-gray-700">Resources</p>
                
                <div class="ml-5">
                  
                    <a href="/about"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">About</a>
                  
                    <a href="/careers"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Careers</a>
                  
                    <a href="/press-releases"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Press</a>
                  
                    <a href="/resources"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Articles</a>
                  
                    <a href="/webinars"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Webinars</a>
                  
                    <a href="https://www.youtube.com/@infinyon/videos"
                      class="block rounded-md px-3 py-2 text-blue-700 hover:bg-gray-50">Videos</a>
                  </div></div>
    </div>
  </div>
</div>
</div>

      </header>
<main>
  <div class="flex flex-1 items-start overflow-hidden max-w-7xl mx-auto py-6">
  <main class="flex-1 overflow-y-auto">
    <section aria-labelledby="primary-heading" class="flex min-w-0 flex-1 flex-col">
      <div class="mx-5">
        <div class="mb-6">
          <nav class="flex" aria-label="Breadcrumb">

  <ol role="list" class="flex items-center space-x-1">
    <li>
      <svg class="h-5 w-5 flex-shrink-0 text-magenta-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" />
      </svg>
    </li>
    <li>
      <a href="/blog" class="text-base text-magenta-200 hover:underline">Blog</a>
    </li>
  </ol>
  <div class="grow"></div>

  <div class="flex flex-row mr-5 items-end text-gray-500">
    <div class="flex items-center text-base  hidden sm:inline-flex whitespace-nowrap">
      <svg class="mr-1.5 h-5 x-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>      
      Read Time: 36 minutes
    </div>
    <div class="flex items-center text-base ml-4">
      <svg class="mr-1.5 h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z" clip-rule="evenodd" />
      </svg>
      February 01, 2021
    </div>
  </div>

</nav></div>
        <div class="mb-6">
          <h1 class="text-2xl md:text-3xl font-semibold font-md tracking-tight tracking-wide leading-tight bg-gradient-to-r from-magenta-800 to-magenta-300 inline-block text-transparent bg-clip-text">
  Build Your Own Custom Robot Assistant
</h1></div>
        <div class="w-full lg:block hidden">
          <img class="mx-auto aspect-[19/10] rounded-lg lg:h-80" src="/blog/images/bot-assistant/social/bot.jpg" alt="Build Your Own Custom Robot Assistant">
        </div>
        <div class="block lg:hidden mt-4">
          <div class="flex flex-row">
            <div class="ml-4">
              <div class="flex flex-col">
  <img src="https://avatars.githubusercontent.com/ajhunyady" alt="A.J. Hunyady" class="h-16 w-16 rounded-full bg-gray-100">
  <div class="text-base leading-6 pt-2">
    <p class="font-semibold text-gray-900">
      <a href="https://github.com/ajhunyady">
        A.J. Hunyady
      </a>
    </p>
    <p class="text-sm text-gray-600">
      Co-founder &amp; CEO, InfinyOn
    </p>
  </div>
</div>
</div>
            <div class="grow"></div>
            <div class="flex flex-col mr-4 sm:mr-10">
              <h5 class="text-base text-gray-500">SHARE ON</h5>
              <div class="mt-1 pt-2">
                <div class="flex flex-row">
  <div class="pr-2 hover:brightness-75">
    <a class="twitter" title="Share on Twitter"
        href="https://twitter.com/intent/tweet?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&text=Build%20Your%20Own%20Custom%20Robot%20Assistant"
        target="_blank">
        <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#00aced"></circle>
  <path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white">
  </path>
</svg></a>    
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="button reddit" title="Share on Reddit"
      href="https://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&title=Build%20Your%20Own%20Custom%20Robot%20Assistant&text=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#ff4500"></circle>
  <path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white">
  </path>
</svg></a>    
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="linkedin" title="Share on LinkedIn"
      href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&title=Build%20Your%20Own%20Custom%20Robot%20Assistant&summary=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#007fb1"></circle>
  <path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white">
  </path>
</svg></a>
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="ycombinator" title="Share on Y Combinator"
      href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&t=Build%20Your%20Own%20Custom%20Robot%20Assistant&text=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
  <circle cx="128" cy="128" r="125" fill="#FB651E"></circle>
	<path d="M119.373653,144.745813 L75.43296,62.4315733 L95.5144533,62.4315733 L121.36192,114.52416 C121.759575,115.452022 122.2235,116.413008 122.753707,117.407147 C123.283914,118.401285 123.747838,119.428546 124.145493,120.48896 C124.410597,120.886615 124.609422,121.251127 124.741973,121.582507 C124.874525,121.913886 125.007075,122.212123 125.139627,122.477227 C125.802386,123.802744 126.39886,125.095105 126.929067,126.354347 C127.459274,127.613589 127.923198,128.773399 128.320853,129.833813 C129.381268,127.580433 130.541078,125.1614 131.80032,122.57664 C133.059562,119.99188 134.351922,117.307747 135.67744,114.52416 L161.92256,62.4315733 L180.612267,62.4315733 L136.27392,145.739947 L136.27392,198.826667 L119.373653,198.826667 L119.373653,144.745813 Z" fill="white">
  </path>
</svg></a>
  </div>
</div></div>
              <div class="mt-1 pt-2">
                <div class="github">
  <a href="https://gitHub.com/infinyon/fluvio/stargazers/"><img src="https://img.shields.io/github/stars/infinyon/fluvio?style=social" alt="GitHub stars"></a>
</div></div>
            </div>
          </div>
        </div>
        <div class="blog mt-8 lg:max-w-5xl max-w-7xl prose prose-quoteless prose-zing prose-md">
          <p>Many successful modern applications need to interact with their users in real-time, and this capability is quickly becoming the expected standard. However, building a real-time application from scratch is a daunting task, pulling focus away from the business problems InfinyOn Team is actually trying to solve. Fluvio is a real-time data streaming platform designed to make real-time application development easy.</p>
<p>In this blog post, we&rsquo;re going to build a <strong>Robot Assistant</strong>, an add-on button on the website, that interacts with users in real-time.</p>
<p><img src="/blog/images/bot-assistant/bot-assistant.svg"
alt="Bot Assistant Example"
style="margin: auto; max-width: 380px" /></p>
<p>We&rsquo;ll build the frontend and backend, then use Fluvio as our data streaming layer.
Fluvio data streaming gives us the ability to react in real-time, deploy to a massive audience, and preserve all data exchanges.</p>
<p>The project is also available for download in <a href="https://github.com/infinyon/fluvio-demo-apps-node/tree/master/bot-assistant" target="_blank">github</a>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This project is using <code>websocket-glue</code> for the client/server communication. For additional information on websocket checkout our blog:</p>
<ul>
<li><a href="http://localhost:1315/blog/2021/01/websocket-glue-for-streaming-apps/">Websocket Glue for Data Streaming Apps</a></li>
</ul>
<p>Familiarity with the following software packages is useful but not required:  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">Javascript</a>, <a href="https://www.typescriptlang.org/docs/" target="_blank">TypeScript</a>, <a href="https://nodejs.org/">Node.js</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket" target="_blank">WebSocket</a>.</p>
<h2 id="overview">Overview</h2>
<p>This blog takes a step-by-step approach to building a robot assistant, called <code>Bot Assistant</code>, from the ground up. The following outline shows the steps involved:</p>
<ul>
<li><a href="#step-1-create-the-project">Step 1: Create the project</a>
<ul>
<li><a href="#add-project-directory">Add project directory</a></li>
<li><a href="#add-nodejs-server">Add node.js server</a></li>
<li><a href="#add-typescript-configuration">Add typescript configuration</a></li>
<li><a href="#add-bot-assistantts-server-file">Add <code>bot-assistant.ts</code> server file</a></li>
</ul>
</li>
<li><a href="#step-2-implement-backend-server">Step 2: Implement backend server</a>
<ul>
<li><a href="#add-messages-type-definition-file">Add messages type definition file</a></li>
<li><a href="#add-state-machine">Add state machine</a></li>
<li><a href="#add-workflow-controller">Add workflow controller</a></li>
<li><a href="#add-proxy-service">Add proxy service</a></li>
<li><a href="#add-bot-serverts-file">Add <code>bot-server.ts</code> file</a></li>
</ul>
</li>
<li><a href="#step-3-implement-frontend-client">Step 3: Implement frontend client</a>
<ul>
<li><a href="#add-indexhtml-file">Add <code>index.html</code> file</a></li>
<li><a href="#add-stylesheet-file">Add stylesheet file</a></li>
<li><a href="#add-assistant-images">Add assistant images</a></li>
<li><a href="#add-assistantjs-script">Add <code>assistant.js</code> script</a></li>
<li><a href="#load-reconnecting-socketjs-file">Load <code>reconnecting-socket.js</code> file</a></li>
<li><a href="#test-bot-assistant-v1">Test Bot Assistant (v1)</a></li>
</ul>
</li>
<li><a href="#step-4-add-data-streaming-and-persistency">Step 4: Add data streaming and persistency</a>
<ul>
<li><a href="#add-fluvio-to-session-controller">Add fluvio to <code>session-controller</code></a></li>
<li><a href="#add-fluvio-to-workflow-controller">Add fluvio to <code>workflow-controller</code></a></li>
<li><a href="#add-fluvio-to-bot-server">Add fluvio to <code>bot-server</code></a></li>
<li><a href="#add-fluvio-setup-script">Add fluvio setup script</a></li>
<li><a href="#test-bot-assistant">Test Bot Assistant</a></li>
</ul>
</li>
</ul>
<h2 id="step-1-create-the-project">Step 1: Create the project</h2>
<p><code>Bot assistant</code> has a client and a server. The client runs in the web browser and controls the frontend user interaction, while the backend runs on a server and manages the websocket proxy and the state machine. The client and the server communicate with ech other through websocket.</p>
<p>Let&rsquo;s get started:</p>
<ul>
<li><a href="#add-project-directory">Add project directory</a></li>
<li><a href="#add-nodejs-server">Add node.js server</a></li>
<li><a href="#add-typescript-configuration">Add typescript configuration</a></li>
<li><a href="#add-bot-assistantts-server-file">Add <code>bot-assistant.ts</code> server file</a></li>
</ul>
<h3 id="add-project-directory">Add project directory</h3>
<p>Create a project directory called <code>bot-assistant</code> with two folders <code>public</code> and <code>src</code>:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p bot-assistant/<span class="o">{</span>public,src<span class="o">}</span> <span class="o">&amp;&amp;</span> <span class="nb">cd</span> bot-assistant
</span></span></code></pre></div><p>The <code>public</code> directory stores the client code, and the <code>src</code> directory contains the server code (the &ldquo;app server&rdquo;). Both the client and the app server are served from the same web server that we&rsquo;ll set up next.</p>
<h3 id="add-nodejs-server">Add node.js server</h3>
<p>Create a Node.js project and implement the server. This project is using Node.js v13:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm init -y
</span></span></code></pre></div><p>which yields the following <code>package.json</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;bot-assistant&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;index.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;test&#34;</span><span class="p">:</span> <span class="s2">&#34;echo \&#34;Error: no test specified\&#34; &amp;&amp; exit 1&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;fluvio &lt;admin@fluvio.io&gt; (fluvio.io)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;Apache 2.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Install <code>express</code>, <code>typescript</code> and a few other development services:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm install typescript express ws @fluvio/client
</span></span></code></pre></div><p>Add watcher and typescript definitions:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm install -D tsc-watch @types/ws @types/node @types/express
</span></span></code></pre></div><p>We installed the following packages:</p>
<ul>
<li><strong>express</strong>: to serve the client and server files.</li>
<li><strong>ws</strong>: for client/server communication.</li>
<li><strong>@fluvio/client</strong>: node API library to communicate with fluvio.</li>
<li><strong>tsc-watch</strong>: to keep track of typescript file changes.</li>
</ul>
<p>Update package.json file as follows:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;bot-assistant&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;bot-assistant.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;start:server&#34;</span><span class="p">:</span> <span class="s2">&#34;tsc-watch --onSuccess \&#34;node ./dist/bot-assistant.js $PARAMS\&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;fluvio &lt;admin@fluvio.io&gt; (fluvio.io)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;Apache 2.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@fluvio/client&#34;</span><span class="p">:</span> <span class="s2">&#34;^0.6.0-beta.3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;express&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.17.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;typescript&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.1.3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ws&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/express&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.17.9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/node&#34;</span><span class="p">:</span> <span class="s2">&#34;^14.14.19&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/ws&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;tsc-watch&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.2.9&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>Change <code>main</code> to reference <code>bot-assistant.js</code> and <code>start:dev</code> script to start the typescript watcher.</p>
<h4 id="add-typescript-configuration">Add typescript configuration</h4>
<p>The project is implemented in typescript which requires a typescript configuration file.</p>
<p>Add the <code>tsconfig.json</code> typescript configuration file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch tsconfig.json
</span></span></code></pre></div><p>Paste the following content in the <code>tsconfig.json</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;compilerOptions&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;target&#34;</span><span class="p">:</span> <span class="s2">&#34;es6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;commonjs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;lib&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;dom&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;ES2017&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;ES2015&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;outDir&#34;</span><span class="p">:</span> <span class="s2">&#34;dist&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;strict&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;moduleResolution&#34;</span><span class="p">:</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;esModuleInterop&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;include&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;src/*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For additional information on the typescript configuration parameters, check out the <a href="https://www.typescriptlang.org/tsconfig" target="_blank">documentation</a>.</p>
<h3 id="add-bot-assistantts-server-file">Add <code>bot-assistant.ts</code> server file</h3>
<p>The <code>package.json</code> file instructs by Node.js to run <code>bot-assistant.js</code> when it initializes. In typescript, this file is compiled from <code>bot-assistant.ts</code>. This is the place where we provision the web server, add routes for the frontend, and initialize backend services.</p>
<p>Create the <code>bot-assistant.ts</code> file in the <code>src</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">touch src/bot-assistant.ts
</span></span></code></pre></div><p>Paste the following content in the <code>src/bot-assistant.ts</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">http</span> <span class="kr">from</span> <span class="s2">&#34;http&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">express</span> <span class="kr">from</span> <span class="s2">&#34;express&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s1">&#39;path&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">9998</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">startServer</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">publicPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/scripts&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/css&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/img&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">Server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sb">`started bot assistant server at http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">...`</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;uncaughtException&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;unhandledRejection&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">startServer</span><span class="p">();</span>
</span></span></code></pre></div><p>This code adds routes for the frontend client and starts a server on port 9998. The routes are as follows:</p>
<ul>
<li><strong>/ (root)</strong> =&gt; `public/index.html</li>
<li><strong>/scripts</strong> =&gt; <code>public/scripts</code></li>
<li><strong>/css</strong> =&gt; <code>public/css</code></li>
<li><strong>/img</strong> =&gt; <code>public/img</code></li>
</ul>
<p>Next, we&rsquo;ll implement the <a href="#step-2-implement-backend-server">backend server</a> followed by the <a href="#step-3-implement-frontend-client">frontend client</a>.</p>
<h2 id="step-2-implement-backend-server">Step 2: Implement backend server</h2>
<p>The backend server has two core services, <code>Proxy Service</code> and <code>Workflow Service</code>.</p>
<p>The <code>Proxy service</code> handles the connection between the client and the workflows. It accepts websocket connections, forwards client messages to the workflow service, and returns the replies to the originator.</p>
<p>The <code>Workflow Service</code> manages state transitions. It initializes the state machine from a json file, accepts client state messages, computes the next state and returns a reply.</p>
<p><img src="/blog/images/bot-assistant/bot-base-architecture.svg"
alt="Bot Assistant Base Architecture"
style="margin: auto; max-width: 800px" /></p>
<p>The backend server implementation has several steps:</p>
<ul>
<li><a href="#add-messages-type-definition-file">Add messages type definition file</a></li>
<li><a href="#add-state-machine">Add state machine</a>
<ul>
<li><a href="#define-state-machine-types">Define state machine types</a></li>
<li><a href="#define-state-transitions">Define state transitions</a></li>
<li><a href="#create-a-state-machine-json-file">Create a state machine JSON file</a></li>
<li><a href="#add-state-machinets-file">Add <code>state-machine.ts</code> file</a></li>
</ul>
</li>
<li><a href="#add-workflow-controller">Add workflow controller</a>
<ul>
<li><a href="#add-workflow-controllerts-file">Add <code>workflow-controller.ts</code> file</a></li>
</ul>
</li>
<li><a href="#add-proxy-service">Add proxy service</a>
<ul>
<li><a href="#add-outgoing-proxy">Add outgoing proxy</a></li>
<li><a href="#add-incoming-proxy">Add incoming proxy</a></li>
<li><a href="#add-session-controller">Add session controller</a></li>
</ul>
</li>
<li><a href="#add-bot-serverts-file">Add <code>bot-server.ts</code> file</a>
<ul>
<li><a href="#update-bot-assistantts-file">Update <code>bot-assistant.ts</code> file</a></li>
</ul>
</li>
</ul>
<p>If you prefer to skip ahead, you can download the source code from <a href="https://github.com/infinyon/fluvio-demo-apps-node/tree/master/bot-assistant/_blog/backend-server" target="_blank">github</a> and resume at <a href="#start-backend-server">start backend server</a>.</p>
<h3 id="add-messages-type-definition-file">Add messages type definition file</h3>
<p>The messages file defines the types of the messages for the client/server communication. The messages are shared by both, proxy and workflow services, and it will be a top level file.</p>
<p>Let&rsquo;s add <code>messages.ts</code> file inside <code>src</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch src/messages.ts
</span></span></code></pre></div><p>Paste the following message type definitions:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">TimeStamp</span> <span class="o">=</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">SID</span> <span class="o">=</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Message</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sid</span>: <span class="kt">SID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">payload?</span>: <span class="kt">Payload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">timestamp</span>: <span class="kt">TimeStamp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">Payload</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">Request</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">Response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Request</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;Request&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">message</span>: <span class="kt">RequestMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Response</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;Response&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">message</span>: <span class="kt">ResponseMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">RequestMessage</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">BotText</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">ChoiceRequest</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">StartChatSession</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">EndChatSession</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">ResponseMessage</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">ChoiceResponse</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="nx">UserText</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">BotText</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;BotText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChoiceRequest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ChoiceRequest&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">question</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">groupId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">choices</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Choice</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Choice</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">itemId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">StartChatSession</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;StartChatSession&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sessionId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chatPrompt?</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chatText?</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">EndChatSession</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;EndChatSession&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sessionId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChoiceResponse</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">groupId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">itemId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content?</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">UserText</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;UserText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sessionId</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content?</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">buildInitMessage</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Message</span><span class="p">&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sid</span>: <span class="kt">sid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timestamp</span>: <span class="kt">getDateTime</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">buildRequest</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">message</span>: <span class="kt">RequestMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Message</span><span class="p">&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sid</span>: <span class="kt">sid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">payload</span><span class="o">:</span> <span class="p">&lt;</span><span class="nt">Request</span><span class="p">&gt;{</span> <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;Request&#34;</span><span class="p">,</span> <span class="nx">message</span>: <span class="kt">message</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timestamp</span>: <span class="kt">getDateTime</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">buildResponse</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">message</span>: <span class="kt">ResponseMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Message</span><span class="p">&gt;{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sid</span>: <span class="kt">sid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">payload</span><span class="o">:</span> <span class="p">&lt;</span><span class="nt">Response</span><span class="p">&gt;{</span> <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;Response&#34;</span><span class="p">,</span> <span class="nx">message</span>: <span class="kt">message</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timestamp</span>: <span class="kt">getDateTime</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">isRequest</span><span class="p">(</span><span class="nx">payload?</span>: <span class="kt">Payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="s2">&#34;Request&#34;</span><span class="p">)</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">getDateTime() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">toISOString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The message definitions are as follows:</p>
<ul>
<li><strong>Message</strong>: is the top level type definition.</li>
<li><strong>Payload</strong>: defines payload types: request or response.</li>
<li><strong>Request</strong>: defines request messages (BotText, ChoiceRequest, StartChatSession, EndChatSession).</li>
<li><strong>Response</strong>: defines response messages (ChoiceResponse, UserText).</li>
<li><strong>BotText</strong>: is a text message sent by the Bot (text parsed as HTML).</li>
<li><strong>ChoiceRequest</strong>: is an array of choices sent by the Bot.</li>
<li><strong>StartChatSession</strong>: is a request by the Bot to enable chat editor.</li>
<li><strong>EndChatSession</strong>: is a request sent by the Bot to disable chat editor.</li>
<li><strong>ChoiceResponse</strong>: is the response to a <em>ChoiceRequest</em>.</li>
<li><strong>UserText</strong>: is text sent by the User.</li>
</ul>
<p>The definitions are followed by a series of helper APIs:</p>
<ul>
<li><strong>buildInitMessage</strong>: creates a message without a payload that indicates a new connection.</li>
<li><strong>buildRequest</strong>: creates a <code>Request</code> message.</li>
<li><strong>buildResponse</strong>: creates a <code>Response</code> message.</li>
<li><strong>isRequest</strong>: checks if the message is of <code>Request</code> kind.</li>
<li><strong>getDateTime</strong>: generates a timestamp.</li>
</ul>
<p>The type definitions are used extensively by the <code>state machine</code> defined in the following section.</p>
<h3 id="add-state-machine">Add state machine</h3>
<p>This project uses a state machine to implement the behavior of the robot assistant. We may think of a state machine as a guided tour where all traffic follows a well-defined path. The state machine defines the choices and the order in which they are to be sent to the client. Upon receipt, the client generates a response and returns an answer. The state machine uses the answer to identify the location to resume and generates the next choice. This request/response exchange continues until the end state is reached.</p>
<h4 id="define-state-machine-types">Define state machine types</h4>
<p>The state machine is a chain of states expressed in a JSON format. Each state can have one of two types: <code>sendRequest</code>, or <code>matchResponse</code>. The <code>sendRequest</code> state instructs the workflow controller to generate a message and wait for the response. When the response arrives, the controller looks up the <code>matchResponse</code> state to identify where it should resume. Each request/response pair has a unique identifier. The identifier is a unique id that defines the context of a client/server message exchange. The final state is defined by a state without a <code>next</code> field.</p>
<p>The workflow controller generates one of the following <code>sendRequest</code> messages:</p>
<ul>
<li><strong>BotText</strong> - sends the client an information field in text or HTML format.</li>
<li><strong>ChoiceRequest</strong> - sends a list of choices to the user. GroupId is the unique identifier paired with a <em>ChoiceResponse</em>.</li>
<li><strong>StartChatSession</strong> - asks the client to enable chat editor. SessionId is the unique identifier paired with a <em>UserText</em></li>
<li><strong>EndChatSession</strong> - ask the client to disable chat session. Uses the SessionId paired with a <em>StartChatSession</em></li>
</ul>
<p>The Client replies with one of the following <code>mathResponse</code> messages:</p>
<ul>
<li><strong>ChoiceResponse</strong> - send one of the choices in the <em>ChoiceRequest</em>.</li>
<li><strong>UserText</strong> - sends text generated by the user.</li>
</ul>
<h4 id="define-state-transitions">Define state transitions</h4>
<p>The state transition have two flows:</p>
<ul>
<li>internal flows - driven by one or more <em>internal states</em>.</li>
<li>external flows - driven by an <em>external state</em>. An external state tells the engine to generate a request and wait for the response before resuming.</li>
</ul>
<p>Internal states have a <code>next</code> field whereas external states have a <code>sessionId</code> or <code>groupId</code> but no <code>next</code> field. Internal states are chained internally, whereas external are chained externally through a client response.</p>
<p>State transitions are triggered by a new connection or a client response. If it begins at an <em>internal state</em>, the engine collects the state information and moves to the next state until it encounters an <em>external state</em>. At that time, it generates a client request and waits for the response before it can resume.</p>
<p><img src="/blog/images/bot-assistant/state-transitions.svg"
alt="State Transitions"
style="margin: auto; max-width: 800px;" /></p>
<p>The client displays the request choices and asks the user to make a selection. Upon selection, the client generates a response and the cycle repeats.</p>
<p>Now that we have defined the state machine and the state transition, let&rsquo;s start the implementation.</p>
<h4 id="create-a-state-machine-json-file">Create a state machine JSON file</h4>
<p>We&rsquo;ll create a state machine asks the user for their favorite programming language and collect their response.</p>
<p>Let&rsquo;s create <code>state-machine</code> directory and add <code>bot-assistant.json</code> file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir state-machines <span class="o">&amp;&amp;</span> touch state-machines/bot-assistant.json
</span></span></code></pre></div><p>Copy following state machine definition in the JSON file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;greetings&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;BotText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Hi, I&#39;m Bot! Nice to meet you.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;langChoices&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;langChoices&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceRequest&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;lang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;question&#34;</span><span class="p">:</span> <span class="s2">&#34;What programming language do you use in your hobby projects?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;choices&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;rust&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Rust&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Go&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;other&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Other&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;langChoiceRust&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;lang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;rust&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;anyOtherChoices&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;langChoiceGo&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;lang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;go&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;anyOtherChoices&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;langChoiceOther&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;lang&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;other&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;startLangPrefSession&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;startLangPrefSession&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;StartChatSession&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sessionId&#34;</span><span class="p">:</span> <span class="s2">&#34;langPreference&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;chatPrompt&#34;</span><span class="p">:</span> <span class="s2">&#34;Type your preferred language here...&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;chatText&#34;</span><span class="p">:</span> <span class="s2">&#34;I enabled chat editor&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;getLangPrefResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;UserText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sessionId&#34;</span><span class="p">:</span> <span class="s2">&#34;langPreference&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;endLangPrefSession&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;endLangPrefSession&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;EndChatSession&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sessionId&#34;</span><span class="p">:</span> <span class="s2">&#34;langPreference&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;anyOtherChoices&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;anyOtherChoices&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceRequest&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;others&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;question&#34;</span><span class="p">:</span> <span class="s2">&#34;Any other?&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;choices&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;yes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Yes&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;no&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;No&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;anyOtherYes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;others&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;langChoices&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;anyOtherNo&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;matchResponse&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;groupId&#34;</span><span class="p">:</span> <span class="s2">&#34;others&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;itemId&#34;</span><span class="p">:</span> <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;next&#34;</span><span class="p">:</span> <span class="s2">&#34;done&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;done&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sendRequest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;kind&#34;</span><span class="p">:</span> <span class="s2">&#34;BotText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Great, thanks!&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The state machine asks users for their favorite programming language and it presents them 3 options: <code>Rust</code>, <code>Go</code>, and <code>Other</code>.</p>
<p>If a user chooses <code>Rust</code> or <code>Go</code>, the state machine return:</p>
<ul>
<li><strong>anyOtherChoices</strong> - another choice with <code>yes</code> or <code>no</code> answers.</li>
</ul>
<p>For <code>Other</code>, it runs through the following states:</p>
<ul>
<li><strong>startLangPrefSession</strong> opens an interactive session,</li>
<li><strong>getLangPrefResponse</strong> captures the user response,</li>
<li><strong>endLangPrefSession</strong> ends the interaction session.</li>
</ul>
<p>This basic state machine show two different interaction models: a choice request/response or a user interaction. When the client receives a choice request, it presents the user with a series of choices. The user clicks on one of the choices and the client generates a response. For an interactive session, the client is asked to open an interactive session for the user to type his answer. After the server receives the response, it sends the client another request to close the interactive session. It is the responsibility of the server to manage access to the user editor.</p>
<p>Next, we need to load the JSON file into memory.</p>
<h4 id="add-state-machinets-file">Add <code>state-machine.ts</code> file</h4>
<p>The state machine is part of the workflow service that we&rsquo;ll define in the next section.</p>
<p>Create a <code>workflow-service</code> directory and add the <code>state-machine.ts</code> file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir src/workflow-service <span class="o">&amp;&amp;</span> touch src/workflow-service/state-machine.ts
</span></span></code></pre></div><p>Paste the following code in the <code>state-machine.ts</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Fs</span> <span class="kr">from</span> <span class="s2">&#34;fs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RequestMessage</span><span class="p">,</span> <span class="nx">ResponseMessage</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../messages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">Name</span> <span class="o">=</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* State Machine definition */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">StateMachine</span> <span class="o">=</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">Name</span><span class="err">,</span> <span class="na">State</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">State</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sendRequest?</span>: <span class="kt">RequestMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">matchResponse?</span>: <span class="kt">ResponseMessage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">next?</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Load state machine from JSON file */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">loadStateMachine</span><span class="p">(</span><span class="nx">filePath</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">jsonFile</span> <span class="o">=</span> <span class="nx">Fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">jsonObject</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">jsonFile</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">state_machine</span>: <span class="kt">StateMachine</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">value</span> <span class="k">in</span> <span class="nx">jsonObject</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">state_machine</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">jsonObject</span><span class="p">[</span><span class="nx">value</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">state_machine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The code reads the JSON file, and provisions an internal state machine variable.</p>
<h3 id="add-workflow-controller">Add workflow controller</h3>
<p>The workflow controller is the mediator between the websocket proxy and the state machine. The controller receives messages from the client, computes the next state, generates a reply, and sends a response.</p>
<h4 id="add-workflow-controllerts-file">Add <code>workflow-controller.ts</code> file</h4>
<p>Add the <code>workflow-controller.ts</code> file to the <code>workflow-service</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch src/workflow-service/workflow-controller.ts
</span></span></code></pre></div><p>Paste the following code:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ResponseMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ChoiceResponse</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">UserText</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buildRequest</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">isRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../messages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">StateMachine</span><span class="p">,</span> <span class="nx">State</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./state-machine&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">SessionController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../proxy-service/session-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">WorkflowController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">initState</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">sessionController</span>: <span class="kt">SessionController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span> <span class="o">=</span> <span class="nx">stateMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">initState</span> <span class="o">=</span> <span class="nx">stateMachine</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionController</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">init</span><span class="p">(</span><span class="nx">sessionController</span>: <span class="kt">SessionController</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionController</span> <span class="o">=</span> <span class="nx">sessionController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">processNewConnection</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">nextStates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">nextStates</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">processNextState</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">response</span>: <span class="kt">ResponseMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">state</span>: <span class="kt">string</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">nextStates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">nextStates</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">response</span>: <span class="kt">ResponseMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">kind</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChoiceResponseState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;UserText&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUserTextState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">processNext</span><span class="p">(</span><span class="nx">startState</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">nextStates</span>: <span class="kt">State</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">startState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nextStates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">next</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: Cannot find next state: </span><span class="si">${</span><span class="nx">next</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">nextStates</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getChoiceResponseState</span><span class="p">(</span><span class="nx">choiceResponse</span>: <span class="kt">ChoiceResponse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">state</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">groupId</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">groupId</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">itemId</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">itemId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: cannot find choice </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">choiceResponse</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getUserTextState</span><span class="p">(</span><span class="nx">userText</span>: <span class="kt">UserText</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">state</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="s2">&#34;UserText&#34;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">sessionId</span> <span class="o">==</span> <span class="nx">userText</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: cannot find user session </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">userText</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">nextStates</span>: <span class="kt">State</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">nextStates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">nextStates</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">buildRequest</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">sessionController</span><span class="p">.</span><span class="nx">processBotMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">processProxyMessage</span><span class="p">(</span><span class="nx">clientMessage</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">message</span>: <span class="kt">Message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">clientMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isRequest</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">processNextState</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">sid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">ResponseMessage</span><span class="p">&gt;</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">processNewConnection</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The workflow controller performs the following functions:</p>
<ul>
<li><strong>constructor</strong>: caches a reference to the <code>stateMachine</code> and computes the initial state.</li>
<li><strong>init</strong>: caches a reference to the <code>sessionController</code>. This is done out of the constructor due to the circular reference. We&rsquo;ll come back to this when in the <code>Fluvio data streaming</code> section.
<ul>
<li><em>Note</em>: The code does not compile until we add the session controller in the following section.</li>
</ul>
</li>
<li><strong>processProxyMessage</strong>: is invoked by session controller to process a new client message. If the message has payload, it asks for next request, otherwise is needs the initial request:
<ul>
<li><strong>processNewConnection</strong> reads the state machine from the first state and produces a request.</li>
<li><strong>processNextState</strong> parses the client response, looks-up the resume state, and produces the next request.</li>
</ul>
</li>
</ul>
<p>The other APIs help the controller match a response and traverse the state machine to generate subsequent requests.</p>
<h3 id="add-proxy-service">Add proxy service</h3>
<p>The proxy service has three components, incoming proxy <code>ProxyIn</code>, outgoing proxy <code>ProxyOut</code> and the session controller. The incoming proxy handles the websocket protocol, outgoing proxy sends messages based on a session id, and the session controller the interaction between the proxy and other services.</p>
<p>For additional details, checkout <a href="http://localhost:1315/blog/2021/01/websocket-glue-for-streaming-apps/">Websocket Glue for Data Streaming Apps</a>.</p>
<h4 id="add-outgoing-proxy">Add outgoing proxy</h4>
<p>Create a directory for the <code>proxy-service</code> and add <code>proxy-out.ts</code> file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir src/proxy-service <span class="o">&amp;&amp;</span> touch src/proxy-service/proxy-out.ts
</span></span></code></pre></div><p>Paste the following code:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">WS</span> <span class="kr">from</span> <span class="s2">&#34;ws&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">SID</span> <span class="o">=</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">WsProxyOut</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">sessions</span>: <span class="kt">Map</span><span class="p">&lt;</span><span class="nt">SID</span><span class="err">,</span> <span class="na">WS</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessions</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">addSession</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">ws</span>: <span class="kt">WS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">ws</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">closeSession</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">message</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As descried in the <a href="http://localhost:1315/blog/2021/01/websocket-glue-for-streaming-apps/">websocket-glue blog</a>, ProxyOut keeps a mapping between session session id and the websocket session.</p>
<h4 id="add-incoming-proxy">Add incoming proxy</h4>
<p>Add <code>proxy-in.ts</code> file to manage the websocket protocol:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch src/proxy-service/proxy-in.ts
</span></span></code></pre></div><p>Paste the following code:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">crypto</span> <span class="kr">from</span> <span class="s1">&#39;crypto&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">WS</span> <span class="kr">from</span> <span class="s2">&#34;ws&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">http</span> <span class="kr">from</span> <span class="s2">&#34;http&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">SessionController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./session-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">COOKIE_NAME</span> <span class="o">=</span> <span class="s2">&#34;Fluvio-Bot-Assistant&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">WsProxyIn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">wss</span>: <span class="kt">WS.Server</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">sessionController</span>: <span class="kt">SessionController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span><span class="nx">sessionController</span>: <span class="kt">SessionController</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WS</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">clientTracking</span>: <span class="kt">false</span><span class="p">,</span> <span class="nx">noServer</span>: <span class="kt">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">sessionController</span> <span class="o">=</span> <span class="nx">sessionController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">init</span><span class="p">(</span><span class="nx">server</span>: <span class="kt">http.Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">onUpgrade</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">onConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">onUpgrade</span><span class="p">(</span><span class="nx">server</span>: <span class="kt">http.Server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;upgrade&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">parseCookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">wss</span><span class="p">.</span><span class="nx">handleUpgrade</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ws</span>: <span class="kt">WS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">wss</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&#34;connection&#34;</span><span class="p">,</span> <span class="nx">ws</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">onConnection() {</span>
</span></span><span class="line"><span class="cl">        <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;headers&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">headers</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">parseCookie</span><span class="p">(</span><span class="nx">COOKIE_NAME</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">20</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">headers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&#34;Set-Cookie: &#34;</span> <span class="o">+</span> <span class="nx">COOKIE_NAME</span> <span class="o">+</span> <span class="s2">&#34;=&#34;</span> <span class="o">+</span> <span class="nx">session</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;connection&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">session_hdr</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">sid</span> <span class="o">=</span> <span class="p">((</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">session_hdr</span><span class="p">))</span> <span class="o">?</span> <span class="nx">session_hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">session_hdr</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">sessionController</span><span class="p">.</span><span class="nx">sessionOpened</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">ws</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;close&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">sessionController</span><span class="p">.</span><span class="nx">sessionClosed</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;message&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">clientMsg</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">await</span> <span class="nx">WsProxyIn</span><span class="p">.</span><span class="nx">sessionController</span><span class="p">.</span><span class="nx">messageFromClient</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">clientMsg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">parseCookie</span><span class="p">(</span><span class="nx">cookieName</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">cookie_hdr?</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">cookie_hdr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">cookiePair</span> <span class="o">=</span> <span class="nx">cookie_hdr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/; */</span><span class="p">).</span><span class="nx">map</span><span class="p">((</span><span class="nx">c</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">v</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}).</span><span class="nx">find</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">cookieName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">cookiePair</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">cookiePair</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">cookiePair</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As descried in the <a href="http://localhost:1315/blog/2021/01/websocket-glue-for-streaming-apps/">websocket-glue blog</a>, the code accepts websocket connections, provisions cookies (<code>Fluvio-Bot-Assistant</code>), and passes the messages to the session controller.</p>
<h4 id="add-session-controller">Add session controller</h4>
<p>Add <code>session-controller.ts</code> file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch src/proxy-service/session-controller.ts
</span></span></code></pre></div><p>Paste the following code:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">WS</span> <span class="kr">from</span> <span class="s2">&#34;ws&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyOut</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-out&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Message</span><span class="p">,</span> <span class="nx">SID</span><span class="p">,</span> <span class="nx">buildInitMessage</span><span class="p">,</span> <span class="nx">buildResponse</span><span class="p">,</span> <span class="nx">isRequest</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../messages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WorkflowController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../workflow-service/workflow-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">Messages</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">Message</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">SessionController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">sessionMessages</span>: <span class="kt">Map</span><span class="p">&lt;</span><span class="nt">SID</span><span class="err">,</span> <span class="na">Messages</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">proxyOut</span>: <span class="kt">WsProxyOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">workflowController</span>: <span class="kt">WorkflowController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">proxyOut</span>: <span class="kt">WsProxyOut</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span> <span class="o">=</span> <span class="nx">proxyOut</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">workflowController</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">init</span><span class="p">(</span><span class="nx">workflowController</span>: <span class="kt">WorkflowController</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">workflowController</span> <span class="o">=</span> <span class="nx">workflowController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sessionOpened</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">ws</span>: <span class="kt">WS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`start session - </span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">addSession</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">ws</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessagesToClient</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">buildInitMessage</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">workflowController</span><span class="p">.</span><span class="nx">processProxyMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sessionClosed</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`end session - </span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">closeSession</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">messageFromClient</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">clientMsg</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb"> &lt;== </span><span class="si">${</span><span class="nx">clientMsg</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">clientResponse</span> <span class="o">=</span> <span class="nx">buildResponse</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">clientMsg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">clientResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">workflowController</span><span class="p">.</span><span class="nx">processProxyMessage</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">clientResponse</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sendMessagesToClient</span><span class="p">(</span><span class="nx">messages</span>: <span class="kt">Messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">clientMessage</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">clientMessage</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">messages</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">processBotMessage</span><span class="p">(</span><span class="nx">botMessage</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">message</span>: <span class="kt">Message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">botMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isRequest</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">show() {</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">table</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;SID&#34;</span><span class="p">,</span> <span class="s2">&#34;Messages&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The session controller keeps a local copy of the messages exchanges anchored by session id. When a known session re-initiates a connection, the controller plays back the messages from memory. All other requests are passed along to the workflow controller.</p>
<p>We are now ready to add the <code>bot-server</code> file and initialize all server components.</p>
<h3 id="add-bot-serverts-file">Add <code>bot-server.ts</code> file</h3>
<p>Add <code>bot-server.ts</code> file in the <code>src</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">touch src/bot-server.ts
</span></span></code></pre></div><p>Paste the following code:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Server</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;http&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyIn</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/proxy-in&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyOut</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/proxy-out&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">StateMachine</span><span class="p">,</span> <span class="nx">loadStateMachine</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./workflow-service/state-machine&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WorkflowController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./workflow-service/workflow-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">SessionController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/session-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">initBotAssistant</span> <span class="o">=</span> <span class="p">(</span><span class="nx">server</span>: <span class="kt">Server</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wsProxyOut</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WsProxyOut</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">sessionController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SessionController</span><span class="p">(</span><span class="nx">wsProxyOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wsProxyIn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WsProxyIn</span><span class="p">(</span><span class="nx">sessionController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">getFileName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span> <span class="o">=</span> <span class="nx">loadStateMachine</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">workflowController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowController</span><span class="p">(</span><span class="nx">stateMachine</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sessionController</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">workflowController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">workflowController</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">sessionController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">wsProxyIn</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">getFileName</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Usage: node bot-assistant.js &lt;state-machine.json&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The bot server file initializes all server components: incoming proxy, outgoing proxy, session controller, state machine and workflow controller.</p>
<p>To address circular reference challenges, it initializes <code>sessionController</code> and <code>workflowController</code> separately from the constructors. We&rsquo;ll come back to this in the <a href="#step-4-add-data-streaming-and-persistency">Fluvio data streaming</a> section.</p>
<h4 id="update-bot-assistantts-file">Update <code>bot-assistant.ts</code> file</h4>
<p>The last step of the implementation integrates <code>initBotAssistant</code> into the <code>bot-assistant.ts</code> file.</p>
<p>Update the <code>bot-assistant.ts</code> file as follows:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">http</span> <span class="kr">from</span> <span class="s2">&#34;http&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">express</span> <span class="kr">from</span> <span class="s2">&#34;express&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">path</span> <span class="kr">from</span> <span class="s1">&#39;path&#39;</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">initBotAssistant</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./bot-server&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">9998</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">startServer</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">publicPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/scripts&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/css&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&#34;/img&#34;</span><span class="p">,</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">publicPath</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="k">await</span> <span class="nx">initBotAssistant</span><span class="p">(</span><span class="nx">Server</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">Server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="sb">`started bot assistant server at http://localhost:</span><span class="si">${</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">...`</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;uncaughtException&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;unhandledRejection&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">startServer</span><span class="p">();</span></span></span></code></pre></div>
<p>The code initializes the <code>bot-server</code> which needs access to HTTP server. Hence <code>initBotAssistant</code> is called after the <code>Server</code> is provisioned, and the server is passed through the function parameter.</p>
<h2 id="start-backend-server">Start backend server</h2>
<p>Let&rsquo;s start the server using the <code>bot-assistant.json</code> state machine file. Npm reads the command line parameters through environment variables:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">PARAMS</span><span class="o">=</span>state-machines/bot-assistant.json npm run start:server
</span></span><span class="line"><span class="cl">4:35:59 PM - Starting compilation in watch mode...
</span></span><span class="line"><span class="cl">4:36:01 PM - Found <span class="m">0</span> errors. Watching <span class="k">for</span> file changes.
</span></span><span class="line"><span class="cl">┌───────────────────┬─────┬────────┐
</span></span><span class="line"><span class="cl">│ <span class="o">(</span>iteration index<span class="o">)</span> │ Key │ Values │
</span></span><span class="line"><span class="cl">├───────────────────┼─────┼────────┤
</span></span><span class="line"><span class="cl">└───────────────────┴─────┴────────┘
</span></span><span class="line"><span class="cl">started bot assistant server at http://localhost:9998...
</span></span></code></pre></div><h2 id="step-3-implement-frontend-client">Step 3: Implement frontend client</h2>
<p>The frontend client has two HTML components:</p>
<ul>
<li><code>Bot</code> button,</li>
<li><code>Bot Assistant</code> dialog box</li>
</ul>
<p>The <code>Bot</code> button is displayed on the lower right-hand side of the screen that opens the <code>Bot Assistant</code> dialog box. The dialog box is closed, the <code>Bot</code> button is shown again. In essence, the two components toggle each other on and off.</p>
<p><img src="/blog/images/bot-assistant/bot-open-close.svg"
alt="Bot Assistant Example"
style="margin: auto; max-width: 420px" /></p>
<p>The client builds the HTML components dynamically through javascript and it communicates with the web server through websocket.</p>
<p>The client is implemented in several steps:</p>
<ul>
<li><a href="#add-indexhtml-file">Add <code>index.html</code> file</a></li>
<li><a href="#add-stylesheet-file">Add stylesheet file</a></li>
<li><a href="#add-assistant-images">Add assistant images</a></li>
<li><a href="#add-assistantjs-script">Add <code>assistant.js</code> script</a></li>
<li><a href="#load-reconnecting-socketjs-file">Load <code>reconnecting-socket.js</code> file</a></li>
<li><a href="#test-bot-assistant-v1">Test Bot Assistant (v1)</a></li>
</ul>
<h3 id="add-indexhtml-file">Add <code>index.html</code> file</h3>
<p>The front end client content is placed in the <code>public</code> directory. Let&rsquo;s add <code>index.html</code> file:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ touch public/index.html
</span></span></code></pre></div><p>Paste the following code in <code>index.html</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;IE=edge&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1.0&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/css&#34;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;css/assistant.css&#34;</span><span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type </span><span class="o">=</span> <span class="s">&#34;text/javascript&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;scripts/assistant.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;assistant&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!-- debugging area - begin --&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;debugOutput&#34;</span> <span class="na">rows</span><span class="o">=</span><span class="s">&#34;20&#34;</span> <span class="na">cols</span><span class="o">=</span><span class="s">&#34;60&#34;</span> <span class="na">readonly</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!-- debugging area - end --&gt;</span>
</span></span><span class="line"><span class="cl">   <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>In the header we are referencing two files:</p>
<ul>
<li><code>css/assistant.css</code> - styles file</li>
<li><code>scripts/assistant.js</code> - script file that builds the DOM elements.</li>
</ul>
<p>In the body, there is a <code>div</code> with class named <code>assistant</code>. The script file looks-up this <code>div</code> to attach DOM elements. For troubleshooting, there is a <code>textarea</code> that prints debugging information.</p>
<h3 id="add-stylesheet-file">Add stylesheet file</h3>
<p>The stylesheet controls the look and feel of the <code>Bot Assistant</code> button dialog box.</p>
<p>Add a stylesheet called <code>assistant.css</code> to <code>public/css</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir public/css <span class="o">&amp;&amp;</span> touch public/css/assistant.css
</span></span></code></pre></div><p>Paste the following code in <code>assistant.css</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-family</span><span class="p">:</span> <span class="s1">&#39;Lucida Sans&#39;</span><span class="p">,</span> <span class="n">Geneva</span><span class="p">,</span> <span class="n">Verdana</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">position</span><span class="p">:</span><span class="kc">fixed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bottom</span><span class="p">:</span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">right</span><span class="p">:</span><span class="mi">25</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">/* Assistant - Button */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="p">.</span><span class="nc">assistant</span> <span class="nt">button</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span> <span class="mi">45</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="mh">#008CBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">cursor</span><span class="p">:</span><span class="kc">pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">outline</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="nt">button</span> <span class="nt">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding-top</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">25</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span> <span class="mi">25</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="nt">button</span><span class="p">:</span><span class="nd">focus</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">border</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">outline</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">/* Assistant - Chat Box */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">chat</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">display</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span><span class="mi">360</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="kc">gray</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span> <span class="mh">#008CBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span><span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span><span class="mi">8</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-weight</span><span class="p">:</span><span class="kc">bold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">line-height</span><span class="p">:</span> <span class="mi">32</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="nt">span</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding-left</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">pt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="nt">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span><span class="mi">18</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-right</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span><span class="p">:</span><span class="kc">right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="nt">img</span><span class="p">.</span><span class="nc">bot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="mh">#bbb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span><span class="p">:</span><span class="kc">left</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="p">.</span><span class="nc">overlay</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="mh">#f6f6f6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">top</span><span class="p">:</span> <span class="mi">32</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">left</span><span class="p">:</span> <span class="mi">33</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">z-index</span><span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="p">.</span><span class="nc">status</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span> <span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="p">.</span><span class="nc">status</span><span class="p">.</span><span class="nc">off</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="mh">#FF3B28</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="p">.</span><span class="nc">status</span><span class="p">.</span><span class="nc">on</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="kc">greenyellow</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">header</span> <span class="p">.</span><span class="nc">close</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span><span class="p">:</span><span class="kc">right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">cursor</span><span class="p">:</span><span class="kc">pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">28</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-right</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">inner-body</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">min-height</span><span class="p">:</span> <span class="mi">250</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">max-height</span><span class="p">:</span> <span class="nb">calc</span><span class="p">(</span><span class="mi">100</span><span class="kt">vh</span> <span class="o">-</span> <span class="mi">300</span><span class="kt">px</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">overflow</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">overflow-x</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-body</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-size</span><span class="p">:</span><span class="mi">12</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">5</span><span class="kt">px</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-bottom</span><span class="p">:</span><span class="mi">7</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">word-break</span><span class="p">:</span> <span class="n">break-all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span> <span class="p">.</span><span class="nc">avatar</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-top</span><span class="p">:</span> <span class="mi">-40</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span> <span class="p">.</span><span class="nc">operator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-top</span><span class="p">:</span> <span class="mi">-40</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-size</span><span class="p">:</span><span class="mf">1.6</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">line-height</span><span class="p">:</span><span class="mf">1.8</span><span class="kt">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">text-align</span><span class="p">:</span><span class="kc">center</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="kc">plum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span><span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span> <span class="nt">img</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">height</span><span class="p">:</span><span class="mi">35</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">50</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="mh">#bbb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#eee</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span> <span class="p">.</span><span class="nc">msg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="mh">#f2f2f2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">min-height</span><span class="p">:</span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#ddd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">7</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-left</span><span class="p">:</span> <span class="mi">44</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-right</span><span class="p">:</span> <span class="mi">30</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-left</span> <span class="p">.</span><span class="nc">button</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin</span><span class="p">:</span> <span class="mi">-2</span><span class="kt">px</span> <span class="mi">30</span><span class="kt">px</span> <span class="mi">7</span><span class="kt">px</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-right</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">position</span><span class="p">:</span> <span class="kc">relative</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">right</span><span class="p">:</span> <span class="mi">0</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin</span><span class="p">:</span> <span class="mi">3</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-bottom</span><span class="p">:</span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-right</span> <span class="p">.</span><span class="nc">msg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="mh">#d4e7fa</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">min-height</span><span class="p">:</span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin-left</span><span class="p">:</span> <span class="mi">80</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">7</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">word-break</span><span class="p">:</span> <span class="n">break-all</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">msg-right</span> <span class="p">.</span><span class="nc">button</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span><span class="p">:</span> <span class="kc">right</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">/* button  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">btn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">display</span><span class="p">:</span> <span class="kc">inline-block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">margin</span><span class="p">:</span> <span class="mi">2</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">button</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="n">max-content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-radius</span><span class="p">:</span><span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">15</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">transition-duration</span><span class="p">:</span> <span class="mf">0.2</span><span class="kt">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span> <span class="mh">#006687</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#008CBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">button</span><span class="p">.</span><span class="nc">selected</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="mh">#008CBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">button</span><span class="p">:</span><span class="nd">hover</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">cursor</span><span class="p">:</span> <span class="kc">pointer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">background-color</span><span class="p">:</span> <span class="mh">#008CBA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span> <span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c">/* footer  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">footer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">background</span><span class="p">:</span><span class="kc">white</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding-bottom</span><span class="p">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">footer</span> <span class="p">.</span><span class="nc">textareaElement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">padding</span><span class="p">:</span> <span class="mi">15</span><span class="kt">px</span> <span class="mi">10</span><span class="kt">px</span> <span class="mi">0</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">border-top</span><span class="p">:</span> <span class="mi">1</span><span class="kt">px</span> <span class="kc">solid</span> <span class="mh">#ccc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">min-height</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">overflow-x</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">overflow-y</span><span class="p">:</span> <span class="kc">auto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-size</span><span class="p">:</span> <span class="mi">11</span><span class="kt">pt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">font-family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="kc">sans-serif</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">color</span><span class="p">:</span> <span class="mh">#333</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">footer</span> <span class="p">.</span><span class="nc">textareaElement</span><span class="p">:</span><span class="nd">focus</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">outline</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">footer</span> <span class="o">[</span><span class="nt">placeholder</span><span class="o">]</span><span class="p">:</span><span class="nd">empty</span><span class="p">::</span><span class="nd">before</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">content</span><span class="p">:</span> <span class="nb">attr</span><span class="p">(</span><span class="n">placeholder</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">color</span><span class="p">:</span> <span class="mh">#aaa</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="nc">assistant</span> <span class="p">.</span><span class="nc">footer</span> <span class="o">[</span><span class="nt">placeholder</span><span class="o">]</span><span class="p">:</span><span class="nd">empty</span><span class="p">:</span><span class="nd">focus</span><span class="p">::</span><span class="nd">before</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">content</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In summary the stylesheet has three sections, <em>Button</em> and <em>Chat Box</em>.</p>
<p>The <em>Chat Box</em> has three subsections: a header with the bot icon, title and a close icon, the body area, and the footer. The footer has an editor for user input that is set to <code>read-only</code>.</p>
<h3 id="add-assistant-images">Add assistant images</h3>
<p>The assistant button and chat dialog box uses several images to enhance the visualization.</p>
<p>Let&rsquo;s create an <code>img</code> directory and use <a href="https://curl.se/docs/" target="_blank">curl</a> to download the images from github:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p public/img/assistant
</span></span><span class="line"><span class="cl">curl -L https://raw.githubusercontent.com/infinyon/fluvio-demo-apps-node/master/bot-assistant/public/img/assistant/note.svg --output public/img/assistant/note.svg
</span></span><span class="line"><span class="cl">curl -L https://raw.githubusercontent.com/infinyon/fluvio-demo-apps-node/master/bot-assistant/public/img/assistant/bot.svg --output public/img/assistant/bot.svg
</span></span><span class="line"><span class="cl">curl -L https://raw.githubusercontent.com/infinyon/fluvio-demo-apps-node/master/bot-assistant/public/img/assistant/redo.svg --output public/img/assistant/redo.svg
</span></span><span class="line"><span class="cl">curl -L https://raw.githubusercontent.com/infinyon/fluvio-demo-apps-node/master/bot-assistant/public/img/assistant/close.svg --output public/img/assistant/close.svg
</span></span></code></pre></div><p>The script download 4 <code>svg</code> images: note, bot, redo and close.</p>
<h3 id="add-assistantjs-script">Add <code>assistant.js</code> script</h3>
<p>The most important component of the frontend client is the <code>assistant.js</code> script. The script creates DOM elements, handles the user interaction, and communicates with the server.</p>
<p>Add the <code>assistant.js</code> file to the <code>public/scripts</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir public/scripts <span class="o">&amp;&amp;</span> touch public/scripts/assistant.js
</span></span></code></pre></div><p>Paste the following code in <code>assistant.js</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">webSocket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">sessionId</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Load reconnecting socket to DOM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">loadScript</span><span class="p">(</span><span class="s2">&#34;scripts/reconnecting-socket.js&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create and attach Bot Assistant HTML elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">loadAssistant</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add assistant button
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">note</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;src&#34;</span><span class="o">:</span> <span class="sb">`img/assistant/note.svg`</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aButton</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;button&#34;</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">note</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Append assistant dialog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="s2">&#34;bot-status&#34;</span><span class="p">,</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;status off&#34;</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">overlay</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;overlay&#34;</span> <span class="p">},</span> <span class="nx">status</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">bot</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;src&#34;</span><span class="o">:</span> <span class="sb">`img/assistant/bot.svg`</span><span class="p">,</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;bot&#34;</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;span&#34;</span><span class="p">,</span> <span class="p">{},</span> <span class="s2">&#34;Bot Assistant&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aDialogClose</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;src&#34;</span><span class="o">:</span> <span class="sb">`img/assistant/close.svg`</span><span class="p">,</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;close&#34;</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aDialogReset</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;src&#34;</span><span class="o">:</span> <span class="sb">`img/assistant/redo.svg`</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">header</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;header&#34;</span> <span class="p">},</span> <span class="p">[</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">overlay</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">aDialogClose</span><span class="p">,</span> <span class="nx">aDialogReset</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">msgBody</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg-body&#34;</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">innerBody</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;inner-body&#34;</span> <span class="p">},</span> <span class="nx">msgBody</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">body</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;body-wrapper&#34;</span> <span class="p">},</span> <span class="nx">innerBody</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">userMsg</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="s2">&#34;user-msg&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;textareaElement&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;placeholder&#34;</span><span class="o">:</span> <span class="s2">&#34;Choose an option&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;contenteditable&#34;</span><span class="o">:</span> <span class="s2">&#34;false&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">footer</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;footer&#34;</span> <span class="p">},</span> <span class="nx">userMsg</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aDialog</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;chat&#34;</span> <span class="p">},</span> <span class="p">[</span><span class="nx">header</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">footer</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Attach event listeners
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">aButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">onOpenDialog</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aDialogClose</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">onCloseDialog</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aDialogReset</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">onResetSession</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Add to document
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">aButton</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">aDialog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// On open assistant dialog callback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">onOpenDialog</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant button&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant .chat&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">openWSConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// On close assistant dialog callback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">onCloseDialog</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant .chat&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.assistant button&#34;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&#34;block&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clear the cookie and restart connection to create a new session.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">onResetSession</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="s2">&#34;Fluvio-Bot-Assistant=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">closeWsConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">clearMessages</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">openWSConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Open WebSocket connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">openWSConnection</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">webSocket</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span><span class="p">;</span> <span class="c1">// already connected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">logOutput</span><span class="p">(</span><span class="s2">&#34;Connecting to: ws://localhost:9998/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReconnectingWebSocket</span><span class="p">(</span><span class="s2">&#34;ws://localhost:9998/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">openEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">clearMessages</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;bot-status&#34;</span><span class="p">).</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;class&#34;</span><span class="p">,</span> <span class="s2">&#34;status on&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">logOutput</span><span class="p">(</span><span class="s2">&#34;Connected!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">closeEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;bot-status&#34;</span><span class="p">).</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;class&#34;</span><span class="p">,</span> <span class="s2">&#34;status off&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">logOutput</span><span class="p">(</span><span class="s2">&#34;Disconnected!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">errorEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">logOutput</span><span class="p">(</span><span class="sb">`Error: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">errorEvent</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">messageEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">var</span> <span class="nx">serverMsg</span> <span class="o">=</span> <span class="nx">messageEvent</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">logOutput</span><span class="p">(</span><span class="sb">`&lt;== </span><span class="si">${</span><span class="nx">serverMsg</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">onMessageFromServer</span><span class="p">(</span><span class="nx">serverMsg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logOutput</span><span class="p">(</span><span class="sb">`error: </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Close WS Connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">closeWsConnection</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">webSocket</span><span class="p">.</span><span class="nx">open</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nx">webSocket</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// On messages received from Websocket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">onMessageFromServer</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">kind</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;BotText&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">showBotText</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;UserText&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">showUserText</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;ChoiceRequest&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">showBotText</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">question</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">showChoiceButtons</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">choices</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">choicesToButton</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;StartChatSession&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">sessionId</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">enableChatEditor</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">chatPrompt</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">chatText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;EndChatSession&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="nx">disableChatEditor</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send a message on WebSocket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">sendWsMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">webSocket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logOutput</span><span class="p">(</span><span class="s2">&#34;WebSocket is not connected: &#34;</span> <span class="o">+</span> <span class="nx">webSocket</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">msgObj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logOutput</span><span class="p">(</span><span class="sb">`==&gt; </span><span class="si">${</span><span class="nx">msgObj</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">webSocket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">msgObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Show text from bot assistant
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">showBotText</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">removeDuplicateAvatar</span><span class="p">(</span><span class="s2">&#34;bot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;img&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;src&#34;</span><span class="o">:</span> <span class="sb">`img/assistant/bot.svg`</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">avatar</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;avatar&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="s2">&#34;bot&#34;</span> <span class="p">},</span> <span class="nx">img</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">msg</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg&#34;</span> <span class="p">},</span> <span class="nx">content</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">msgLeft</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg-left&#34;</span> <span class="p">},</span> <span class="p">[</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">avatar</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.msg-body&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">msgLeft</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">scrollToBottom</span><span class="p">(</span><span class="s2">&#34;.inner-body&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Show text from user interactive session
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">showUserText</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg&#34;</span> <span class="p">},</span> <span class="nx">content</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">msgLeft</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg-right&#34;</span> <span class="p">},</span> <span class="nx">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.msg-body&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">msgLeft</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">scrollToBottom</span><span class="p">(</span><span class="s2">&#34;.inner-body&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Show choices
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">showChoiceButtons</span><span class="p">(</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">choices</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">choices</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">buttons</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">choices</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">choice</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;button&#34;</span> <span class="p">},</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">button</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">pickChoice</span><span class="p">(</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">itemId</span><span class="p">,</span> <span class="nx">choice</span><span class="p">.</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">buttons</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;btn&#34;</span> <span class="p">},</span> <span class="nx">button</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">msgLeft</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg-left&#34;</span><span class="p">,</span> <span class="s2">&#34;id&#34;</span><span class="o">:</span> <span class="nx">groupId</span> <span class="p">},</span> <span class="nx">buttons</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.msg-body&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">msgLeft</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">scrollToBottom</span><span class="p">(</span><span class="s2">&#34;.inner-body&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Callback invoked on user selection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">pickChoice</span><span class="p">(</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">itemId</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">choicesToButton</span><span class="p">(</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">sendWsMessage</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">groupId</span><span class="o">:</span> <span class="nx">groupId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">itemId</span><span class="o">:</span> <span class="nx">itemId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Swap choices with a button representing the selection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">choicesToButton</span><span class="p">(</span><span class="nx">groupId</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">groupId</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;button selected&#34;</span> <span class="p">},</span> <span class="nx">content</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">btn</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;btn&#34;</span> <span class="p">},</span> <span class="nx">button</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">msgRight</span> <span class="o">=</span> <span class="nx">createElement</span><span class="p">(</span><span class="s2">&#34;div&#34;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&#34;class&#34;</span><span class="o">:</span> <span class="s2">&#34;msg-right&#34;</span> <span class="p">},</span> <span class="nx">btn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&#34;.msg-body&#34;</span><span class="p">).</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">msgRight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">scrollToBottom</span><span class="p">(</span><span class="s2">&#34;.inner-body&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// On multiple bot messages, ensure avatar is only displayed on last entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">removeDuplicateAvatar</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.msg-body&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">lastMessage</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">[</span><span class="nx">messages</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">lastMessage</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&#34;class&#34;</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;msg-left&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">lastMessage</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">lastMessage</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">lastMessage</span><span class="p">.</span><span class="nx">lastChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Enable interactive chat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">enableChatEditor</span><span class="p">(</span><span class="nx">chatPrompt</span><span class="p">,</span> <span class="nx">chatText</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">chatText</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">showBotText</span><span class="p">(</span><span class="nx">chatText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">chatBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;user-msg&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;contenteditable&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;placeholder&#34;</span><span class="p">,</span> <span class="nx">chatPrompt</span> <span class="o">||</span> <span class="s2">&#34;Type question here ...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;keydown&#34;</span><span class="p">,</span> <span class="nx">onEditorKeys</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable interactive chat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">disableChatEditor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">chatBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;user-msg&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;keydown&#34;</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;contenteditable&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chatBox</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&#34;placeholder&#34;</span><span class="p">,</span> <span class="s2">&#34;Choose an option&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Scroll to last messages
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">scrollToBottom</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">tag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">div</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">div</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">div</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clear messages in both editors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">clearMessages</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.msg-body&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">debugOutput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;debugOutput&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">debugOutput</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">debugOutput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Capture editor keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">onEditorKeys</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">chatBox</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;user-msg&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="s1">&#39;Enter&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">chatBox</span><span class="p">.</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">chatBox</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sendWsMessage</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="nx">kind</span><span class="o">:</span> <span class="s2">&#34;UserText&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">sessionId</span><span class="o">:</span> <span class="nx">sessionId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">content</span><span class="o">:</span> <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="nx">showUserText</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">chatBox</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//  Load external javascript file to DOM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">loadScript</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">js_script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">js_script</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&#34;text/javascript&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">js_script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">fileName</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">js_script</span><span class="p">.</span><span class="kr">async</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">js_script</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Log output in the &#34;debugOutput&#34; textarea (if available) and the console
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">logOutput</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">debugOutput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;debugOutput&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">debugOutput</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">debugOutput</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">+</span> <span class="s2">&#34;\n\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">debugOutput</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">debugOutput</span><span class="p">.</span><span class="nx">scrollHeight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create element utility function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">,</span> <span class="nx">inner</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&#34;undefined&#34;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">inner</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&#34;undefined&#34;</span><span class="p">)</span> <span class="p">{</span> <span class="nx">inner</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">el</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">inner</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inner</span> <span class="o">=</span> <span class="p">[</span><span class="nx">inner</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">inner</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">inner</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">tagName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">inner</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">el</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">inner</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">el</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Call main function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">loadAssistant</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>The script is invoked during <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event" target="_blank">window.onload</a> event. The functions are as follows:</p>
<ul>
<li><strong>loadAssistant</strong> - creates DOM elements for the button and editor, and attaches event listeners.</li>
<li><strong>onOpenDialog</strong> - shows dialog and hides button.</li>
<li><strong>onCloseDialog</strong> - shows button and hides dialog.</li>
<li><strong>onResetSession</strong> - clears the session cookie and establishes a new connection (a new cookie gets assigned).</li>
<li><strong>openWsConnection</strong> - connects to websocket server and attaches event listeners.</li>
<li><strong>closeWsConnection</strong> - closes the connection</li>
<li><strong>onMessageFromServer</strong> - parses messages received from the server and publishes the result in the chat editor.</li>
<li><strong>sendWsMessage</strong> - sends a message to the server.</li>
<li><strong>loadScript</strong> - loads another script into the DOM.</li>
<li><strong>createElement</strong> - a utility function that makes it easy to create DOM elements.</li>
</ul>
<p>The other APIs are manipulating various DOM elements, enable/disable chat editor and clear the messages.</p>
<p>The script also loads <code>reconnecting-websocket.js</code> file which is discussed in the next section.</p>
<h3 id="load-reconnecting-socketjs-file">Load <code>reconnecting-socket.js</code> file</h3>
<p>The client is responsible for establishing and maintaining the connection to the server. While vanilla websocket offers the primitives to connect and disconnect to and from the server, it leaves it up to the user to implement reconnects.</p>
<p><a href="https://github.com/joewalnes" target="_blank">Joe Walnes</a> has written a great utility called <a href="https://github.com/joewalnes/reconnecting-websocket" target="_blank">reconnecting-socket.js</a> that that that implements the reconnection logic under the hood.</p>
<p>Let&rsquo;s copy the file in the <code>public/scripts</code> directory:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ curl -L https://raw.githubusercontent.com/infinyon/fluvio-demo-apps-node/master/bot-assistant/public/scripts/reconnecting-socket.js --output public/scripts/reconnecting-socket.js
</span></span></code></pre></div><p>Let&rsquo;s review the <code>public</code> directory hierarchy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">public
</span></span><span class="line"><span class="cl">├── css
</span></span><span class="line"><span class="cl">│   └── assistant.css
</span></span><span class="line"><span class="cl">├── img
</span></span><span class="line"><span class="cl">│   └── assistant
</span></span><span class="line"><span class="cl">│       ├── bot.svg
</span></span><span class="line"><span class="cl">│       ├── close.svg
</span></span><span class="line"><span class="cl">│       ├── note.svg
</span></span><span class="line"><span class="cl">│       └── redo.svg
</span></span><span class="line"><span class="cl">├── index.html
</span></span><span class="line"><span class="cl">└── scripts
</span></span><span class="line"><span class="cl">    ├── assistant.js
</span></span><span class="line"><span class="cl">    └── reconnecting-socket.js
</span></span></code></pre></div><p>The frontend client is available for download in github.</p>
<h3 id="test-bot-assistant-v1">Test Bot Assistant (v1)</h3>
<p>Ensure the server is running, otherwise run the following command:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nv">PARAMS</span><span class="o">=</span>state-machines/bot-assistant.json npm run start:server
</span></span></code></pre></div><p>In the web browser, open <code>http://localhost:9999/</code>, then click on &ldquo;Bot Assistant` button.  Click on the choices and see the bot assistant traverse through our state machine:</p>
<p><img src="/blog/images/bot-assistant/workflow-end-to-end.svg"
alt="Workflow end-to-end"
style="margin: auto; max-width: 700px" /></p>
<p>Congratulations, <code>Bot Assistant</code> is up and running.</p>
<h2 id="step-4-add-data-streaming-and-persistency">Step 4: Add data streaming and persistency</h2>
<p>As seen in the previous section, <code>Bot Assistant</code> works well, but it has some limitations. If the webserver restarts, all messages are lost and all user sessions are reset.</p>
<p>We&rsquo;ll use <a href="https://fluvio.io">Fluvio</a> to remediate this issue. Fluvio is a high throughput, low latency data streaming platform that scales horizontally to handle persistency for a large number of concurrent messages.</p>
<p>We can deploy Fluvio between the connection proxy and the workflow controller, which also enables us to divide our monolith into two independent services (aka. microservices): <code>Proxy Service</code> and <code>Workflow Service</code>:</p>
<p><img src="/blog/images/bot-assistant/architecture.svg"
alt="Bot Assistant Architecture"
style="margin: auto; max-width: 780px" /></p>
<p>When services are bridged by Fluvio we gain additional benefits:</p>
<ul>
<li>
<p><strong>scale</strong> the proxy and workflow independently of each other.</p>
</li>
<li>
<p><strong>handoff</strong> a conversation to a human operator. We can do that by adding an <code>operator service</code> independently that interacts directly with the client through the data stream.</p>
</li>
<li>
<p><strong>add-on services</strong> such as: analytics, machine learning, or connectors to other products.</p>
</li>
</ul>
<p>We can also remove the <em>circular reference</em> hack we implemented between <code>session-controller</code> and <code>workflow-controller</code>.</p>

<div class="mb-3"><aside class="callout idea">
  <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.0" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
  </svg>
  <div class="content">
 <strong>Prerequisites:</strong> This section assumes you have access to a Fluvio cluster. If you don&rsquo;t have access to a cluster, check out the <a href="https://fluvio.io/docs/get-started/mac/">getting started guide</a> to create <a href="https://fluvio.io/docs/get-started/cloud/">Infinyon Cloud</a> account.
</div></aside></div>
<p>To integrate Fluvio data streaming we&rsquo;ll make the following changes:</p>
<ul>
<li><a href="#add-fluvio-to-session-controller">Add fluvio to <code>session-controller</code></a></li>
<li><a href="#add-fluvio-to-workflow-controller">Add fluvio to <code>workflow-controller</code></a></li>
<li><a href="#add-fluvio-to-bot-server">Add fluvio to <code>bot-server</code></a></li>
<li><a href="#add-fluvio-setup-script">Add fluvio setup script</a></li>
</ul>
<h3 id="add-fluvio-to-session-controller">Add fluvio to <code>session-controller</code></h3>
<p>In the <code>session-controller.ts</code> file we replace references to <code>workflow-controller</code> with fluvio producers. In addition to that, the session controller can now use fluvio to look-up all transaction for a specific session.</p>
<p>Update <code>src/proxy-service/session-controller.ts</code> with the following code changes:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">WS</span> <span class="kr">from</span> <span class="s2">&#34;ws&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyOut</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-out&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Message</span><span class="p">,</span> <span class="nx">SID</span><span class="p">,</span> <span class="nx">buildInitMessage</span><span class="p">,</span> <span class="nx">buildResponse</span><span class="p">,</span> <span class="nx">isRequest</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../messages&#34;</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">TopicProducer</span><span class="p">,</span> <span class="nx">PartitionConsumer</span><span class="p">,</span> <span class="nx">Offset</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@fluvio/client&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">Messages</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">Message</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">SessionController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">sessionMessages</span>: <span class="kt">Map</span><span class="p">&lt;</span><span class="nt">SID</span><span class="err">,</span> <span class="na">Messages</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">proxyOut</span>: <span class="kt">WsProxyOut</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="nx">fluvioProducer</span>: <span class="kt">TopicProducer</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="nx">fluvioConsumer</span>: <span class="kt">PartitionConsumer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">proxyOut</span>: <span class="kt">WsProxyOut</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">fluvioProducer</span>: <span class="kt">TopicProducer</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">fluvioConsumer</span>: <span class="kt">PartitionConsumer</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span> <span class="o">=</span> <span class="nx">proxyOut</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioProducer</span> <span class="o">=</span> <span class="nx">fluvioProducer</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioConsumer</span> <span class="o">=</span> <span class="nx">fluvioConsumer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">init() {</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">fluvioConsumer</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">Offset</span><span class="p">.</span><span class="nx">FromBeginning</span><span class="p">())).</span><span class="nx">toRecords</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">msg</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioConsumer</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="nx">Offset</span><span class="p">.</span><span class="nx">FromEnd</span><span class="p">(),</span> <span class="p">(</span><span class="nx">msg</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">processBotMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">sessionOpened</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">ws</span>: <span class="kt">WS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`start session - </span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">addSession</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">ws</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessagesToClient</span><span class="p">(</span><span class="nx">messages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">buildInitMessage</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">fluvioProducer</span><span class="p">.</span><span class="nx">sendRecord</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sessionClosed</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`end session - </span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">closeSession</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">messageFromClient</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">clientMsg</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">sid</span><span class="si">}</span><span class="sb"> &lt;== </span><span class="si">${</span><span class="nx">clientMsg</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">clientResponse</span> <span class="o">=</span> <span class="nx">buildResponse</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">clientMsg</span><span class="p">));</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">fluvioProducer</span><span class="p">.</span><span class="nx">sendRecord</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">clientResponse</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sendMessagesToClient</span><span class="p">(</span><span class="nx">messages</span>: <span class="kt">Messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">clientMessage</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">proxyOut</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">clientMessage</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">Message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">messages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">messages</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">messages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">messages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">processBotMessage</span><span class="p">(</span><span class="nx">botMessage</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">message</span>: <span class="kt">Message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">botMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">addMessageToSession</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isRequest</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">sendMessageToClient</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">show() {</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">table</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">sessionMessages</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">table</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="nx">table</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;SID&#34;</span><span class="p">,</span> <span class="s2">&#34;Messages&#34;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>The code changes are as follows:</p>
<ul>
<li><strong>constructor</strong> - saves fluvio <code>topicProducer</code> and <code>topicConsumer</code> in a local variable.</li>
<li><strong>init</strong>:
<ul>
<li>made <code>async</code>,</li>
<li>to fetch fluvio messages and cache them in <code>sessionMessages</code> array,</li>
<li>to register <code>processBotMessage</code> callback to <code>fluvioConsumer</code>.</li>
</ul>
</li>
<li><strong>sessionOpened</strong> - made <code>async</code> to write a new message to the fluvio data stream.</li>
<li><strong>messageFromClient</strong> - made <code>async</code> to write client messages to fluvio data stream (instead of calling workflow-controller).</li>
</ul>
<p>That&rsquo;s it, <code>session-controller</code> can now be deployed as a stand-alone service without any dependencies on <code>workflow service</code>.</p>
<h3 id="add-fluvio-to-workflow-controller">Add fluvio to <code>workflow-controller</code></h3>
<p>Similarly, in the <code>workflow-controller.ts</code> file we replace references to <code>session-controller</code> with fluvio producers.</p>
<p>Update <code>src/workflow-service/workflow-controller.ts</code> with the following code changes:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Message</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ResponseMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ChoiceResponse</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">UserText</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buildRequest</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">isRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;../messages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">StateMachine</span><span class="p">,</span> <span class="nx">State</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./state-machine&#34;</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">TopicProducer</span><span class="p">,</span> <span class="nx">PartitionConsumer</span><span class="p">,</span> <span class="nx">Offset</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@fluvio/client&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">WorkflowController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">initState</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="nx">fluvioProducer</span>: <span class="kt">TopicProducer</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="nx">fluvioConsumer</span>: <span class="kt">PartitionConsumer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">fluvioProducer</span>: <span class="kt">TopicProducer</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">fluvioConsumer</span>: <span class="kt">PartitionConsumer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span> <span class="o">=</span> <span class="nx">stateMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">initState</span> <span class="o">=</span> <span class="nx">stateMachine</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">next</span><span class="p">().</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioProducer</span> <span class="o">=</span> <span class="nx">fluvioProducer</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioConsumer</span> <span class="o">=</span> <span class="nx">fluvioConsumer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">public</span> <span class="nx">init() {</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">fluvioConsumer</span><span class="p">.</span><span class="nx">stream</span><span class="p">(</span><span class="nx">Offset</span><span class="p">.</span><span class="nx">FromEnd</span><span class="p">(),</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">sessionMsg</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">processProxyMessage</span><span class="p">(</span><span class="nx">sessionMsg</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">        <span class="p">});</span>
</span></span><span class="line hl"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">processNewConnection</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">nextStates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">nextStates</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">processNextState</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">response</span>: <span class="kt">ResponseMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">state</span>: <span class="kt">string</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">nextStates</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">processNext</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">nextStates</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getState</span><span class="p">(</span><span class="nx">response</span>: <span class="kt">ResponseMessage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">kind</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;ChoiceResponse&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChoiceResponseState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;UserText&#34;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUserTextState</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">processNext</span><span class="p">(</span><span class="nx">startState</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">nextStates</span>: <span class="kt">State</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">startState</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nextStates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">next</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">state</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: Cannot find next state: </span><span class="si">${</span><span class="nx">next</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">nextStates</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getChoiceResponseState</span><span class="p">(</span><span class="nx">choiceResponse</span>: <span class="kt">ChoiceResponse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">state</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">groupId</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">groupId</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">itemId</span> <span class="o">==</span> <span class="nx">choiceResponse</span><span class="p">.</span><span class="nx">itemId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: cannot find choice </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">choiceResponse</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getUserTextState</span><span class="p">(</span><span class="nx">userText</span>: <span class="kt">UserText</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">state</span><span class="p">]</span> <span class="k">of</span> <span class="k">this</span><span class="p">.</span><span class="nx">stateMachine</span><span class="p">.</span><span class="nx">entries</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">kind</span> <span class="o">==</span> <span class="s2">&#34;UserText&#34;</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">state</span><span class="p">.</span><span class="nx">matchResponse</span><span class="p">.</span><span class="nx">sessionId</span> <span class="o">==</span> <span class="nx">userText</span><span class="p">.</span><span class="nx">sessionId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error: cannot find user session </span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">userText</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">initState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">sendMessages</span><span class="p">(</span><span class="nx">sid</span>: <span class="kt">SID</span><span class="p">,</span> <span class="nx">nextStates</span>: <span class="kt">State</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">nextStates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">nextStates</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">buildRequest</span><span class="p">(</span><span class="nx">sid</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">                <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">fluvioProducer</span><span class="p">.</span><span class="nx">sendRecord</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">message</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">processProxyMessage</span><span class="p">(</span><span class="nx">clientMessage</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">message</span>: <span class="kt">Message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">clientMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isRequest</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">sid</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">processNextState</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">sid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">ResponseMessage</span><span class="p">&gt;</span><span class="nx">message</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">message</span>
</span></span><span class="line"><span class="cl">                <span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">processNewConnection</span><span class="p">(</span><span class="nx">sid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>The code changes are as follows:</p>
<ul>
<li><strong>constructor</strong> - saves fluvio <code>topicProducer</code> and <code>topicConsumer</code> in a local variable.</li>
<li><strong>init</strong> - registers <code>processProxyMessage</code> to callback <code>fluvioConsumer</code>.</li>
<li><strong>processNewConnection</strong> - made <code>async</code> to use sendMessages.</li>
<li><strong>processNextState</strong> - made <code>async</code> to use sendMessages.</li>
<li><strong>sendMessages</strong> -  made <code>async</code> to write client message to the fluvio data stream (instead of calling session-controller).</li>
<li><strong>processProxyMessage</strong> - made <code>async</code> to <code>processNewConnection</code>.</li>
</ul>
<p>The workflow controller is now a stand-alone service decoupled from <code>session-controller</code>. The Fluvio middle tier allows these services to be moved to a different machine and be scaled-up independently. However, this improvement is beyond the scope of this blog.</p>
<h3 id="add-fluvio-to-bot-server">Add fluvio to <code>bot-server</code></h3>
<p>The <code>bot-server</code> is responsible for the initialization of the producer and consumer. After initialization, the producer and the consumer are passed to the <code>session-controller</code> and <code>workflow-controller</code> for processing.</p>
<p>Update <code>src/bot-server.ts</code> with the following code changes:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Server</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;http&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyIn</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/proxy-in&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WsProxyOut</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/proxy-out&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">StateMachine</span><span class="p">,</span> <span class="nx">loadStateMachine</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./workflow-service/state-machine&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WorkflowController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./workflow-service/workflow-controller&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">SessionController</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./proxy-service/session-controller&#34;</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="kr">import</span> <span class="nx">Fluvio</span> <span class="kr">from</span> <span class="s1">&#39;@fluvio/client&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="kr">const</span> <span class="nx">BOT_ASSIST_MESSAGES</span> <span class="o">=</span> <span class="s2">&#34;bot-assist-messages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">initBotAssistant</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">server</span>: <span class="kt">Server</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">fluvio</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Fluvio</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">    <span class="k">await</span> <span class="nx">checkTopic</span><span class="p">(</span><span class="nx">fluvio</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">fluvioProducer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fluvio</span><span class="p">.</span><span class="nx">topicProducer</span><span class="p">(</span><span class="nx">BOT_ASSIST_MESSAGES</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">fluvioConsumer</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fluvio</span><span class="p">.</span><span class="nx">partitionConsumer</span><span class="p">(</span><span class="nx">BOT_ASSIST_MESSAGES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wsProxyOut</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WsProxyOut</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">sessionController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SessionController</span><span class="p">(</span><span class="nx">wsProxyOut</span><span class="p">,</span> <span class="nx">fluvioProducer</span><span class="p">,</span> <span class="nx">fluvioConsumer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">wsProxyIn</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WsProxyIn</span><span class="p">(</span><span class="nx">sessionController</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">getFileName</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">stateMachine</span>: <span class="kt">StateMachine</span> <span class="o">=</span> <span class="nx">loadStateMachine</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">workflowController</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WorkflowController</span><span class="p">(</span><span class="nx">stateMachine</span><span class="p">,</span> <span class="nx">fluvioProducer</span><span class="p">,</span> <span class="nx">fluvioConsumer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="k">await</span> <span class="nx">sessionController</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">    <span class="nx">workflowController</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">wsProxyIn</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">getFileName</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Usage: node bot-assistant.js &lt;state-machine.json&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="kr">const</span> <span class="nx">checkTopic</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">fluvio</span>: <span class="kt">Fluvio</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">    <span class="kr">const</span> <span class="nx">admin</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fluvio</span><span class="p">.</span><span class="nx">admin</span><span class="p">();</span>
</span></span><span class="line hl"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">await</span> <span class="nx">admin</span><span class="p">.</span><span class="nx">findTopic</span><span class="p">(</span><span class="nx">BOT_ASSIST_MESSAGES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Error: Fluvio topic not found! Run `npm run setup`&#34;</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">    <span class="p">}</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>The code changes are as follows:</p>
<ul>
<li><strong>BOT_ASSIST_MESSAGES</strong> - defines bot assistant topic name.</li>
<li><strong>fluvio</strong> - connects to fluvio, checks topic existence, and provisions <code>fluvioProducer</code> and <code>fluvioConsumer</code>.</li>
<li><strong>SessionController</strong> - passes <code>fluvioProducer</code> and <code>fluvioConsumer</code> to session controller.</li>
<li><strong>WorkflowController</strong> - passes <code>fluvioProducer</code> and <code>fluvioConsumer</code> to workflow controller.</li>
</ul>
<p>Congratulations! You made all code changes for <code>Bot Assistant</code>. Next, we&rsquo;ll add couple of scripts to add/remove topic and we are ready for testing.</p>
<h3 id="add-fluvio-setup-script">Add fluvio setup script</h3>
<p>Fluvio needs a setup script to perform administrative operations such as add/remove topics. Let&rsquo;s add a couple of files to perform these operations and link the files with npm.</p>

<div class="mb-3"><aside class="callout idea">
  <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.0" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
  </svg>
  <div class="content">
 This section assumes that the <a href="https://www.fluvio.io/download/">Fluvio CLI</a> is installed on your machine.
</div></aside></div>
<p>Create a <code>tools</code> directory and add <code>setup.sh</code> and <code>cleanup.sh</code> files:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir tools
</span></span><span class="line"><span class="cl">touch tools/setup.sh <span class="o">&amp;&amp;</span> chmod +x tools/setup.sh
</span></span><span class="line"><span class="cl">touch tools/cleanup.sh <span class="o">&amp;&amp;</span> chmod +x tools/cleanup.sh
</span></span></code></pre></div><p>Paste the following in the <code>setup.sh</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>fluvio topic create bot-assist-messages
</span></span></code></pre></div><p>Paste the following in the <code>cleanup.sh</code> file:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>fluvio topic delete bot-assist-messages
</span></span></code></pre></div><p>Finally, update <code>package.json</code> file to link the script files:</p>
<div class="copy-code"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;bot-assistant&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.0.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;main&#34;</span><span class="p">:</span> <span class="s2">&#34;bot-assistant.js&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scripts&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;start:server&#34;</span><span class="p">:</span> <span class="s2">&#34;tsc-watch --onSuccess \&#34;node ./dist/bot-assistant.js $PARAMS\&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;setup&#34;</span><span class="p">:</span> <span class="s2">&#34;sh ./tools/setup.sh&#34;</span><span class="p">,</span>
</span></span><span class="line hl"><span class="cl">    <span class="nt">&#34;cleanup&#34;</span><span class="p">:</span> <span class="s2">&#34;sh ./tools/cleanup.sh&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="s2">&#34;fluvio &lt;admin@fluvio.io&gt; (fluvio.io)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;license&#34;</span><span class="p">:</span> <span class="s2">&#34;Apache 2.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;dependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@fluvio/client&#34;</span><span class="p">:</span> <span class="s2">&#34;^0.6.0-beta.3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;express&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.17.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;typescript&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.1.3&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ws&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devDependencies&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/express&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.17.9&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/node&#34;</span><span class="p">:</span> <span class="s2">&#34;^14.14.19&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@types/ws&#34;</span><span class="p">:</span> <span class="s2">&#34;^7.4.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;tsc-watch&#34;</span><span class="p">:</span> <span class="s2">&#34;^4.2.9&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
<p>Let&rsquo;s run setup, to create the new topic:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ npm run setup
</span></span><span class="line"><span class="cl">&gt; bot-assistant@1.0.0 setup /projects/bot-assistant
</span></span><span class="line"><span class="cl">&gt; sh ./tools/setup.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">topic <span class="s2">&#34;bot-assist-messages&#34;</span> created
</span></span></code></pre></div><p>Congratulations! You have completed changes in the for <code>Bot Assistant</code> project.</p>
<h3 id="test-bot-assistant">Test Bot Assistant</h3>
<p>Repeat the tests in <a href="#test-bot-assistant-v1">Test Bot Assistant (v1)</a> and refresh the screen. Note that the messages are refreshed as they have been persistent by Fluvio.</p>
<p>The persistence also survives server reboots. Go ahead and reboot the server and refresh the browser screen. Notice how the messages are preserved.</p>
<p>Furthermore, you can now use Fluvio or other programs with a Fluvio consumer interface to read session messages.</p>
<p>Let&rsquo;s read the last 5 messages with <a href="https://www.fluvio.io/download/">Fluvio CLI</a>:</p>
<div class="copy-first-line"></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">fluvio consume bot-assist-messages --offset<span class="o">=</span><span class="s2">&#34;-4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;sid&#34;</span>:<span class="s2">&#34;fb7e2971d989070361c30d825bf6a853a406916e&#34;</span>,<span class="s2">&#34;payload&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Response&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;ChoiceResponse&#34;</span>,<span class="s2">&#34;groupId&#34;</span>:<span class="s2">&#34;others&#34;</span>,<span class="s2">&#34;itemId&#34;</span>:<span class="s2">&#34;no&#34;</span>,<span class="s2">&#34;content&#34;</span>:<span class="s2">&#34;No&#34;</span><span class="o">}}</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;2021-01-05T17:58:46.511&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;sid&#34;</span>:<span class="s2">&#34;fb7e2971d989070361c30d825bf6a853a406916e&#34;</span>,<span class="s2">&#34;payload&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Request&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;BotText&#34;</span>,<span class="s2">&#34;content&#34;</span>:<span class="s2">&#34;Great, thanks!&#34;</span><span class="o">}}</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;2021-01-05T17:58:46.514&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;sid&#34;</span>:<span class="s2">&#34;fb7e2971d989070361c30d825bf6a853a406916e&#34;</span>,<span class="s2">&#34;payload&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Response&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;ResetSession&#34;</span><span class="o">}}</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;2021-01-05T18:04:20.811&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;sid&#34;</span>:<span class="s2">&#34;0fb1574b3b6d7c98c7089aa4a2c58a80894bbc6e&#34;</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;2021-01-05T18:04:20.815&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;sid&#34;</span>:<span class="s2">&#34;0fb1574b3b6d7c98c7089aa4a2c58a80894bbc6e&#34;</span>,<span class="s2">&#34;payload&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Request&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;BotText&#34;</span>,<span class="s2">&#34;content&#34;</span>:<span class="s2">&#34;Hi, I&#39;m Bot! Nice to meet you.&#34;</span><span class="o">}}</span>,<span class="s2">&#34;timestamp&#34;</span>:<span class="s2">&#34;2021-01-05T18:04:20.817&#34;</span><span class="o">}</span>
</span></span></code></pre></div><p>When you use fluvio to transfer real-time messages between services, you gain much more than a transport layer. Benefits range from decoupling service to recovering from errors, from monitoring to troubleshooting and much more.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this blog, we explored how to build a robot assistant that can interact with users in real-time. By using Fluvio, our application has a foundation that allows it to scale horizontally to meet the demands of a massive user audience. Since our backend services are stateless and decoupled, we can scale them independently to handle the particular load characteristics that we observe in production, preventing technical bottlenecks.</p>
<p>This project also just scratches the surface of what a real-time streaming application can do. By leveraging Fluvio&rsquo;s persistent data streams, we can build improvements to our application by simply writing new microservices that interact with topic data. This gives us the power to develop new real-time features, as well as to analyze historical data for purposes such as Machine Learning personalization use-cases.</p>
<p>
We hope you enjoyed the blog! If you have any questions or comments, or if you just want to come say hi, you can find us on our community Discord channel →
<a href="https://discordapp.com/invite/bBG2dTz">
<img style="height:8%;width:auto;display:inline" src="https://img.shields.io/discord/695712741381636168?color=738ADB&logo=Discord" alt="Discord" />
</a>
</p>

        </div>      
      </div>

    </section>
  </main> 

  <aside class="hidden mx-5 w-72 overflow-y-auto lg:block py-6">
  <article class="flex flex-col items-start px-4">

    <h2 class="text-sm text-gray-500 tracking-widest">
      SHARE ON
    </h2>
    <hr class="border-b-0 border-gray-200 w-full mt-3 pb-4 w-5/6" />
    <div class="w-full mx-auto pb-4">
      <div class="flex flex-row">
  <div class="pr-2 hover:brightness-75">
    <a class="twitter" title="Share on Twitter"
        href="https://twitter.com/intent/tweet?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&text=Build%20Your%20Own%20Custom%20Robot%20Assistant"
        target="_blank">
        <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#00aced"></circle>
  <path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white">
  </path>
</svg></a>    
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="button reddit" title="Share on Reddit"
      href="https://www.reddit.com/submit?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&title=Build%20Your%20Own%20Custom%20Robot%20Assistant&text=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#ff4500"></circle>
  <path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white">
  </path>
</svg></a>    
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="linkedin" title="Share on LinkedIn"
      href="https://www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&title=Build%20Your%20Own%20Custom%20Robot%20Assistant&summary=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
  <circle cx="32" cy="32" r="31" fill="#007fb1"></circle>
  <path d="M20.4,44h5.4V26.6h-5.4V44z M23.1,18c-1.7,0-3.1,1.4-3.1,3.1c0,1.7,1.4,3.1,3.1,3.1 c1.7,0,3.1-1.4,3.1-3.1C26.2,19.4,24.8,18,23.1,18z M39.5,26.2c-2.6,0-4.4,1.4-5.1,2.8h-0.1v-2.4h-5.2V44h5.4v-8.6 c0-2.3,0.4-4.5,3.2-4.5c2.8,0,2.8,2.6,2.8,4.6V44H46v-9.5C46,29.8,45,26.2,39.5,26.2z" fill="white">
  </path>
</svg></a>
  </div>
  <div class="pr-2 hover:brightness-75">
    <a class="ycombinator" title="Share on Y Combinator"
      href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2flocalhost%3a1315%2fblog%2f2021%2f02%2fbot-assistant&t=Build%20Your%20Own%20Custom%20Robot%20Assistant&text=Use%20data%20streaming%20to%20build%20a%20custom%20robot%20assistant%20that%20can%20connect%20to%20any%20backend%20service%20in%20the%20organization."
      target="_blank">
      <svg class="w-9 h-9" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
  <circle cx="128" cy="128" r="125" fill="#FB651E"></circle>
	<path d="M119.373653,144.745813 L75.43296,62.4315733 L95.5144533,62.4315733 L121.36192,114.52416 C121.759575,115.452022 122.2235,116.413008 122.753707,117.407147 C123.283914,118.401285 123.747838,119.428546 124.145493,120.48896 C124.410597,120.886615 124.609422,121.251127 124.741973,121.582507 C124.874525,121.913886 125.007075,122.212123 125.139627,122.477227 C125.802386,123.802744 126.39886,125.095105 126.929067,126.354347 C127.459274,127.613589 127.923198,128.773399 128.320853,129.833813 C129.381268,127.580433 130.541078,125.1614 131.80032,122.57664 C133.059562,119.99188 134.351922,117.307747 135.67744,114.52416 L161.92256,62.4315733 L180.612267,62.4315733 L136.27392,145.739947 L136.27392,198.826667 L119.373653,198.826667 L119.373653,144.745813 Z" fill="white">
  </path>
</svg></a>
  </div>
</div></div>

    <h2 class="mt-4 text-sm text-gray-500 tracking-widest">
      AUTHOR
    </h2>
    <hr class="border-b-0 border-gray-200 w-full mt-3 pb-4 w-5/6" />

    <div class="w-full mx-auto flex flex-col items-start">
      <div class="flex flex-col">
  <img src="https://avatars.githubusercontent.com/ajhunyady" alt="A.J. Hunyady" class="h-16 w-16 rounded-full bg-gray-100">
  <div class="text-base leading-6 pt-2">
    <p class="font-semibold text-gray-900">
      <a href="https://github.com/ajhunyady">
        A.J. Hunyady
      </a>
    </p>
    <p class="text-sm text-gray-600">
      Co-founder &amp; CEO, InfinyOn
    </p>
  </div>
</div>
</div>

    <h2 class="mt-8 text-sm text-gray-500 tracking-widest">
      FLUVIO OSS
    </h2>
    <hr class="border-b-0 border-gray-200 w-full mt-3 pb-6 w-5/6" />
    <div class="github">
  <a href="https://gitHub.com/infinyon/fluvio/stargazers/"><img src="https://img.shields.io/github/stars/infinyon/fluvio?style=social" alt="GitHub stars"></a>
</div>
<h2 class="mt-12 text-sm text-gray-500 tracking-widest">
  INFINYON CLOUD
</h2>
<hr class="border-b-0 border-gray-200 w-full mt-3 pb-3" />
<div class="mt-2 py-5 w-full rounded-md bg-gradient-to-r from-magenta-800 to-magenta-400">
  <a href="https://infinyon.cloud/signup">
  <h3 class="text-base font-semibold text-pink-400 text-center">
    Accelerated Onboarding
  </h3>
  <div class="pt-1 flex flex-row">
    <div class="flex flex-col w-4/6 justify-center">
      <h5 class="text-xs text-gray-100 pl-3">
         Sign-up for personalized assistance from dedicated InfinyOn architect.
      </h5>
    </div>
    <div class="flex flex-col mt-2 mr-2 h-20 w-20 rounded-md bg-black items-center justify-center">
      <h5 class="text-base leading-5 font-bold text-neon-300 w-16 break-words text-center">
        Free $3000
      </h5>
        <h6 class="text-xxs text-gray-100 pt-1">
          2000 credits
        </h6>
    </div>
  </div>
  </a>
</div></article>
</aside></div>

<script src="/js/copy-code.js"></script></main>
    </div>
    <footer class="bg-gray-900" aria-labelledby="footer-heading">
  <h2 id="footer-heading" class="sr-only">Footer</h2>

  <div class="mx-auto max-w-7xl px-6 pb-16 pt-16 lg:px-8">
    <div class="lg:grid lg:grid-cols-10 lg:gap-8">

      
      <div class="lg:col-span-2 space-y-6">
        <img class="h-7 w-auto" src="/assets/infinyon-logo-text-white.svg" alt="InfinyOn">
        <p class="text-sm leading-6 text-gray-300"></p>
        <div class="flex space-x-6">
            <a href="https://github.com/infinyon" class="text-gray-300 hover:text-gray-100" target="_blank"><span class="sr-only">GitHub</span>
<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path fill-rule="evenodd"
        d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
        clip-rule="evenodd" />
</svg>
            </a>
            <a href="https://twitter.com/infinyon" class="text-gray-300 hover:text-gray-100" target="_blank"><span class="sr-only">Twitter</span>
<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path
        d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" />
</svg>
            </a>
            <a href="https://linkedin.com/company/infinyon" class="text-gray-300 hover:text-gray-100" target="_blank"><span class="sr-only">linkedin</span>
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" aria-hidden="true" viewBox="0 0 448 512">
  <path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/>
</svg>
            </a>
            <a href="https://discordapp.com/invite/bBG2dTz" class="text-gray-300 hover:text-gray-100" target="_blank"><span class="sr-only">discord</span>
<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" aria-hidden="true"
    viewBox="0 0 640 512">
    <path d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z" />
</svg>
            </a>
            <a href="https://www.youtube.com/@infinyon" class="text-gray-300 hover:text-gray-100" target="_blank"><span class="sr-only">YouTube</span>
<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path fill-rule="evenodd"
        d="M19.812 5.418c.861.23 1.538.907 1.768 1.768C21.998 8.746 22 12 22 12s0 3.255-.418 4.814a2.504 2.504 0 0 1-1.768 1.768c-1.56.419-7.814.419-7.814.419s-6.255 0-7.814-.419a2.505 2.505 0 0 1-1.768-1.768C2 15.255 2 12 2 12s0-3.255.417-4.814a2.507 2.507 0 0 1 1.768-1.768C5.744 5 11.998 5 11.998 5s6.255 0 7.814.418ZM15.194 12 10 15V9l5.194 3Z"
        clip-rule="evenodd" />
</svg>
            </a>
        </div>
      </div>

      
      <div class="lg:col-span-8">
        <div class="mt-16 lg:mt-0 grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-12">
          <div>
            <h3 class="text-sm font-semibold leading-4 text-white">Cloud</h3>
            <ul role="list" class="mt-6 space-y-2">
                <li>
                  <a href="/infinyon-cloud" class="text-sm leading-6 text-gray-300 hover:text-white">
                    InfinyOn Cloud
                </a>
                </li>
                <li>
                  <a href="https://infinyon.cloud/signup" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Sign Up
                </a>
                </li>
                <li>
                  <a href="https://infinyon.cloud/login" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Login
                </a>
                </li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold leading-4 text-white">Product</h3>
            <ul role="list" class="mt-6 space-y-2">
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    InfinyOn Platform
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    InfinyOn Hub
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Connectors
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Webhooks
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    SmartModules
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Event Streams
                </a>
                </li>
                <li>
                  <a href="#" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Stateful Streams
                </a>
                </li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold leading-4 text-white">Solutions</h3>
            <ul role="list" class="mt-6 space-y-2">
                <li>
                  <a href="/iot" class="text-sm leading-6 text-gray-300 hover:text-white">
                    IoT Aggregation
                </a>
                </li>
                <li>
                  <a href="/clickstream" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Website Monitoring
                </a>
                </li>
                <li>
                  <a href="/" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Microservices Event Bridge
                </a>
                </li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold leading-4 text-white">About</h3>
            <ul role="list" class="mt-6 space-y-2">
                <li>
                  <a href="/about" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Company
                </a>
                </li>
                <li>
                  <a href="/careers" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Careers
                </a>
                </li>
                <li>
                  <a href="/resources" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Articles
                </a>
                </li>
                <li>
                  <a href="/press-releases" class="text-sm leading-6 text-gray-300 hover:text-white">
                    News
                </a>
                </li>
                <li>
                  <a href="/webinars" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Webinars
                </a>
                </li>
                <li>
                  <a href="https://www.youtube.com/@infinyon/videos" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Videos
                </a>
                </li>
                <li>
                  <a href="/blog" class="text-sm leading-6 text-gray-300 hover:text-white">
                    Blog
                </a>
                </li>
            </ul>
          </div>
          
        </div>
      </div>

    </div>

    
    <div class="mt-8 border-t border-white/10 pt-4 text-center">
      <div class="text-center text-xs text-gray-400">
        
        <span><a href="/legal/privacy">Privacy Policy</a></span>
           
          <span class="px-1">|</span> <span><a href="/legal/security">Security</a></span>
           
          <span class="px-1">|</span> <span><a href="/legal/user-agreement">Terms and Conditions</a></span>
           
          <span class="px-1">|</span> <span><a href="/legal/cookies">Cookie Notice</a></span>
          
      </div>
      <p class="text-xs leading-5 text-gray-400">&copy; <span id="year"></span> InfinyOn, Inc. All rights reserved.</p>
      <script>
        document.getElementById("year").innerHTML = new Date().getFullYear();
      </script>
    </div>
  </div>
</footer>
    
  </body>
</html>